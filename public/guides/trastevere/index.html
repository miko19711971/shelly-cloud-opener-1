<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Guest Help â€” Viale Trastevere 108</title>
<link rel="icon" type="image/jpeg" href="logo-niceflatinrome.jpg">
<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f6f6}
.wrap{max-width:760px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e0e0e0;padding:10px 14px}
.h-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.h-left{display:flex;align-items:center;gap:10px}
.brand{font-weight:700;color:#a33}
.apt{margin-left:auto;opacity:.75}
img.logo{height:36px;width:auto;display:block}
.controls{display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap}
.lang{display:flex;gap:6px;margin-left:auto}
.lang button{border:1px solid #ddd;background:#fff;padding:6px 8px;border-radius:10px;cursor:pointer;font-size:13px}
.lang button[aria-current="true"]{background:#2b2118;color:#fff;border-color:#2b2118}
#voiceBtn{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:10px;cursor:pointer;font-size:14px}
#voiceBtn[aria-pressed="true"]{background:#2b2118;color:#fff;border-color:#2b2118}
main{flex:1;padding:12px}
.msg{max-width:85%;line-height:1.35;border-radius:12px;padding:10px 12px;margin:8px 0;white-space:pre-wrap}
.msg.wd{background:#fff;border:1px solid #e0e0e0}
.msg.me{background:#e8f0fe;border:1px solid #c5d5ff;margin-left:auto}
.quick{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.quick button{border:1px solid #d6c5b8;background:#fff;color:#333;padding:6px 10px;border-radius:12px;cursor:pointer}
.quick button:active{transform:translateY(1px)}
footer{position:sticky;bottom:0;background:#fff;display:flex;gap:8px;padding:10px;border-top:1px solid #e0e0e0}
input{flex:1;padding:12px;border:1px solid #cbd5e1;border-radius:10px;outline:none}
#sendBtn{padding:12px 14px;border:1px solid #2b2118;background:#2b2118;color:#fff;border-radius:10px;cursor:pointer}
.intro{background:#fff;border:1px solid #e0e0e0;padding:12px;border-radius:12px;margin:12px 0}
.intro b{display:block;margin-bottom:6px}
.small{opacity:.7;font-size:12px;margin-top:6px}

/* --- Feedback UI --- */
.fb-box{margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.fb-box .fb-label{font-size:12px;opacity:.7;margin-right:4px}
.fb-box button{border:1px solid #ddd;background:#fff;padding:6px 10px;border-radius:999px;cursor:pointer}
.fb-box button:active{transform:scale(0.98)}
.fb-done{font-size:12px;opacity:.8}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="h-row">
      <div class="h-left">
        <img class="logo" src="logo-niceflatinrome.jpg" alt="NiceFlatInRome">
        <div class="brand">niceflatinrome.com</div>
      </div>
      <div class="apt"><span id="aptLabel">Apartment</span>: VIALETRASTEVERE108</div>
    </div>
    <div class="controls">
      <button id="voiceBtn" aria-pressed="false" title="Toggle voice">ðŸ”‡ Voice: Off</button>
      <nav class="lang" aria-label="Language">
        <button data-lang="en" aria-current="true">EN</button>
        <button data-lang="it">IT</button>
        <button data-lang="fr">FR</button>
        <button data-lang="de">DE</button>
        <button data-lang="es">ES</button>
      </nav>
    </div>
  </header>

  <main id="chat" aria-live="polite"></main>

  <footer>
    <input id="input" placeholder="Hi, I am Samantha, your virtual guide. Tap a button for a quick answer â€” or type hereâ€¦" autocomplete="off">
    <button id="sendBtn">Send</button>
  </footer>
</div>

<script>
/* === CONFIG === */
const APARTMENT_ID = "VIALETRASTEVERE108";
/* Se in futuro ridistribuisci la Web App e cambia l'URL, aggiorna qui sotto */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxCm83uKeMsUw0UKDk-QrKg-3pNsdpP28yUTOuMe1qeHUtreCnhjf3_AwFAV5Mz_1a/exec";

/* ============ CONTENUTI LOCALIZZATI ============ */
const DATA = {
  en: {
    ui: {
      welcome: "Hi, I am Samantha, your virtual guide. Tap a button to get a quick answer.",
      placeholder: "Hi, I am Samantha, your virtual guide. Tap a button for a quick answer â€” or type hereâ€¦",
      apt_label: "Apartment",
      voice_on: "ðŸ”Š Voice: On",
      voice_off: "ðŸ”‡ Voice: Off",
      quick: ["wifi","check in","check out","water","AC","bathroom","kitchen","building","eat","drink","shop","visit","experience","day trips","transport","services","emergency"],
      fallback: "I did not find a direct answer. Try a quick button (wifi, kitchen, transport, visitâ€¦)."
    },
    apt: {
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:'Near the TV there is a WHITE router. Turn it around to see the label with SSID & password.',
      wifi_ssid:'See router label', wifi_password:'See router label',
      water_note:'Tap water is safe to drink. Hot water is always on.',
      ac_note:'Please turn OFF the air conditioning when you leave the apartment.',
      bathroom_amenities:'Toilet paper, hand soap, bath mat, hairdryer.',
      towels_note:'Per guest: 1 large + 1 medium towel. Beds are prepared on arrival.',
      bathroom_notice:'IMPORTANT (bathroom between the bedrooms): use ONLY the toilet paper provided. Do NOT flush anything else or the system will clog and overflow. Unclogging costs â‚¬100.',
      bedrooms_note:'Two bedrooms + a double sofa bed. Keys are on the table on arrival.',
      gas_steps:'Gas handle (left of the meter): DOWN = CLOSED â€¢ HORIZONTAL = OPEN. To cook: 1) choose burner, 2) push knob down and turn, 3) keep pressed a few seconds until the flame is steady, 4) release.',
      kitchen_note:'The kitchen is fully stocked and ready to use.',
      main_door_hours:'Building door accessible with the key provided.',
      concierge:'Concierge: Massimo â€” desk hours 08:30â€“13:00 and 15:30â€“18:30.',
      registration_note:'Please send your passports via WhatsApp to the host for mandatory guest registration.',
      host_phone:'+39 335 5245756',
      supermarkets:'Mini-market on Viale Trastevere near 108 â€¢ Fresh produce at Largo/Piazza San Cosimato (mornings).',
      pharmacies:'Pharmacy at Piazza Trilussa â€¢ Other options along Viale Trastevere.',
      luggage:'Radical Storage â€” Piazza Mastai (â‰ˆ5 min).',
      laundry:'Self-service laundry â€” Viale Trastevere 150.',
      hospital:'Ospedale Nuovo Regina Margherita â€” Via Emilio Morosini 30.',
      atms:'ATMs along Viale Trastevere (BNL, Unicredit, Intesa).',
      sims:'Vodafone (Viale Trastevere 143) â€¢ TIM (Piazza San Cosimato 70).',
      transport:'Tram 8 â†’ Largo Argentina / Piazza Venezia. Tram 3 nearby. Bus H â†’ Termini. Taxi: +39 06 3570 or FreeNow app.',
      airports:'Fiumicino: Tram 8 â†’ Trastevere Station â†’ FL1 train (~45 min). Ciampino: bus to Termini then Tram 8. Private transfer: Welcome Pickups.',
      emergency:'EU Emergency 112 â€¢ Police 113 â€¢ Ambulance 118 â€¢ Fire 115 â€¢ English-speaking doctor +39 06 488 2371 â€¢ 24h vet +39 06 660 681',
      eat:'Da Enzo al 29; Osteria der Belli; Tonnarello; Trattoria Da Teo; Spirito di Vino; Pianostrada; Trapizzino.',
      drink:'Enoteca Ferrara; Freni e Frizioni; Lâ€™Angolo Divino; MimÃ¬ e CocÃ²; La Prosciutteria Trastevere.',
      shop:'Porta Portese Market (Sun); artisanal bakeries & delis along Viale Trastevere; Via della Lungaretta boutiques.',
      visit:'Santa Maria in Trastevere; Santa Cecilia; Museo di Roma in Trastevere; Orto Botanico; Villa Farnesina; Piazza Trilussa; walk over Ponte Sisto to Campo deâ€™ Fiori.',
      experiences:'Evening walk: Viale Trastevere â†’ Piazza Trilussa â†’ Santa Maria â†’ alleys â†’ Tiber waterfront â†’ Campo deâ€™ Fiori. Aperitivo at Freni e Frizioni; church tour (S. Maria & S. Cecilia); sunset at Gianicolo.',
      romantic_walk:'Start: Viale Trastevere 108 â†’ Piazza S. Maria in Trastevere â†’ Gianicolo Terrace â†’ Orto Botanico â†’ Gelateria del Viale â†’ Biscottificio Innocenti â†’ back to Viale Trastevere 108.',
      daytrips:'Ostia Antica (~40 min) â€¢ Tivoli (Villa dâ€™Este & Hadrianâ€™s Villa ~1h) â€¢ Castelli Romani (villages & wine).',
      checkout_note:'Before leaving: turn off lights/AC, close windows, leave keys on the table, and lock the door.'
    },
    intents: [
      {k:'wifi',keys:['wifi','wi-fi','internet','password','router'],t:a=>`Wi-Fi: ${a.wifi_note}\nNetwork: ${a.wifi_ssid}. Password: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','arrival','access','self check-in','entrance','intercom','doorbell'],t:a=>`Check-in from ${a.checkin_time}.\n${a.bedrooms_note}\n${a.registration_note}\n${a.concierge}\nNeed help? Call ${a.host_phone}.`},
      {k:'check out',keys:['check out','leave','departure'],t:a=>a.checkout_note},
      {k:'water',keys:['water','hot water','drinkable','tap'],t:a=>a.water_note},
      {k:'AC',keys:['ac','air conditioning','aircon','air'],t:a=>a.ac_note},
      {k:'bathroom',keys:['bathroom','hairdryer','soap','towels','toilet','notice'],t:a=>`Bathrooms: ${a.bathroom_amenities}\nTowels: ${a.towels_note}\n${a.bathroom_notice}`},
      {k:'kitchen',keys:['kitchen','cook','cooking','stove','gas'],t:a=>`${a.kitchen_note}\nGas use: ${a.gas_steps}`},
      {k:'building',keys:['building','elevator','door','hours','concierge'],t:a=>`Door: ${a.main_door_hours}\n${a.concierge}`},
      {k:'services',keys:['pharmacy','hospital','atm','sim','laundry','luggage','supermarket','groceries'],t:a=>`Supermarkets: ${a.supermarkets}\nPharmacies: ${a.pharmacies}\nHospital: ${a.hospital}\nATMs: ${a.atms}\nLaundry: ${a.laundry}\nLuggage storage: ${a.luggage}\nSIMs: ${a.sims}`},
      {k:'transport',keys:['transport','tram','bus','taxi','airport','train','metro'],t:a=>`${a.transport}\nAirports: ${a.airports}`},
      {k:'eat',keys:['eat','restaurant','dinner','lunch','food'],t:a=>a.eat},
      {k:'drink',keys:['drink','bar','wine','cocktail','aperitivo'],t:a=>a.drink},
      {k:'shop',keys:['shop','market','shopping','bakeries'],t:a=>a.shop},
      {k:'visit',keys:['visit','what to visit','see','sight','attraction','museum'],t:a=>a.visit},
      {k:'experience',keys:['experience','walk','tour','itinerary','sunset','romantic'],t:a=>`${a.experiences}\nRomantic route: ${a.romantic_walk}`},
      {k:'day trips',keys:['day trip','tivoli','ostia','castelli','excursion','bracciano'],t:a=>a.daytrips},
      {k:'emergency',keys:['emergency','police','ambulance','fire','doctor','vet'],t:a=>a.emergency}
    ]
  },

  it: {
    ui:{
      welcome:"Ciao, sono Samantha, la tua guida virtuale. Tocca un pulsante per una risposta rapida.",
      placeholder:"Ciao, sono Samantha, la tua guida virtuale. Tocca un pulsante â€” oppure scrivi quiâ€¦",
      apt_label:"Appartamento", voice_on:"ðŸ”Š Voce: On", voice_off:"ðŸ”‡ Voce: Off",
      quick:["wifi","check in","check out","acqua","aria condizionata","bagno","cucina","edificio","mangiare","bere","shopping","visitare","esperienze","gite di un giorno","trasporti","servizi","emergenza"],
      fallback:"Non ho trovato una risposta diretta. Prova un pulsante (wifi, cucina, trasporti, visitareâ€¦)."
    },
    apt:{
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:'Vicino alla TV câ€™Ã¨ un router BIANCO. Giralo per leggere sullâ€™etichetta SSID e password.',
      wifi_ssid:'Vedi etichetta del router', wifi_password:'Vedi etichetta del router',
      water_note:'Lâ€™acqua del rubinetto Ã¨ potabile. Lâ€™acqua calda Ã¨ sempre attiva.',
      ac_note:'Spegni lâ€™aria condizionata quando lasci lâ€™appartamento.',
      bathroom_amenities:'Carta igienica, sapone mani, tappetino, asciugacapelli.',
      towels_note:'Per ospite: 1 telo grande + 1 medio. Letti pronti allâ€™arrivo.',
      bathroom_notice:'IMPORTANTE (bagno tra le camere): usare SOLO la carta igienica fornita. NON gettare altro nel WC: si intasa e tracima. Sblocco â‚¬100.',
      bedrooms_note:'Due camere da letto + divano letto matrimoniale. Le chiavi sono sul tavolo allâ€™arrivo.',
      gas_steps:'Manopola gas (a sinistra del contatore): IN BASSO = CHIUSO â€¢ ORIZZONTALE = APERTO. Per cucinare: 1) scegli il fuoco, 2) premi e gira la manopola, 3) tieni premuto pochi secondi finchÃ© la fiamma Ã¨ stabile, 4) rilascia.',
      kitchen_note:'Cucina completa e pronta allâ€™uso.',
      main_door_hours:'Portone accessibile con la chiave fornita.',
      concierge:'Portineria: Massimo â€” orari 08:30â€“13:00 e 15:30â€“18:30.',
      registration_note:'Per la registrazione obbligatoria, invia i passaporti via WhatsApp allâ€™host.',
      host_phone:'+39 335 5245756',
      supermarkets:'Mini-market su Viale Trastevere vicino al 108 â€¢ Prodotti freschi a Largo/Piazza San Cosimato (mattina).',
      pharmacies:'Farmacia a Piazza Trilussa â€¢ Altre lungo Viale Trastevere.',
      luggage:'Radical Storage â€” Piazza Mastai (â‰ˆ5 min).',
      laundry:'Lavanderia self-service â€” Viale Trastevere 150.',
      hospital:'Ospedale Nuovo Regina Margherita â€” Via Emilio Morosini 30.',
      atms:'Bancomat lungo Viale Trastevere (BNL, Unicredit, Intesa).',
      sims:'Vodafone (Viale Trastevere 143) â€¢ TIM (Piazza San Cosimato 70).',
      transport:'Tram 8 â†’ Largo Argentina / Piazza Venezia. Tram 3 vicino. Bus H â†’ Termini. Taxi: +39 06 3570 o app FreeNow.',
      airports:'Fiumicino: Tram 8 â†’ Stazione Trastevere â†’ FL1 (~45 min). Ciampino: bus per Termini poi Tram 8. Transfer privato: Welcome Pickups.',
      emergency:'Emergenze UE 112 â€¢ Polizia 113 â€¢ Ambulanza 118 â€¢ Vigili del Fuoco 115 â€¢ Medico in inglese +39 06 488 2371 â€¢ Veterinario 24h +39 06 660 681',
      eat:'Da Enzo al 29; Osteria der Belli; Tonnarello; Trattoria Da Teo; Spirito di Vino; Pianostrada; Trapizzino.',
      drink:'Enoteca Ferrara; Freni e Frizioni; Lâ€™Angolo Divino; MimÃ¬ e CocÃ²; La Prosciutteria Trastevere.',
      shop:'Mercato di Porta Portese (dom); forni e gastronomie artigianali su Viale Trastevere; boutique in Via della Lungaretta.',
      visit:'Santa Maria in Trastevere; Santa Cecilia; Museo di Roma in Trastevere; Orto Botanico; Villa Farnesina; Piazza Trilussa; passeggiata su Ponte Sisto verso Campo deâ€™ Fiori.',
      experiences:'Passeggiata serale: Viale Trastevere â†’ Piazza Trilussa â†’ S. Maria â†’ vicoli â†’ Lungotevere â†’ Campo deâ€™ Fiori. Aperitivo da Freni e Frizioni; chiese (S. Maria & S. Cecilia); tramonto al Gianicolo.',
      romantic_walk:'Partenza: Viale Trastevere 108 â†’ Piazza S. Maria in Trastevere â†’ Terrazza del Gianicolo â†’ Orto Botanico â†’ Gelateria del Viale â†’ Biscottificio Innocenti â†’ ritorno.',
      daytrips:'Ostia Antica (~40 min) â€¢ Tivoli (Villa dâ€™Este & Villa Adriana ~1h) â€¢ Castelli Romani.',
      checkout_note:'Prima di partire: spegni luci/AC, chiudi le finestre, lascia le chiavi sul tavolo e chiudi a chiave la porta.'
    },
    intents:[
      {k:'wifi',keys:['wifi','wi-fi','internet','password','router'],t:a=>`Wi-Fi: ${a.wifi_note}\nRete: ${a.wifi_ssid}. Password: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','arrivo','accesso','self check-in','ingresso','citofono','campanello'],t:a=>`Check-in dalle ${a.checkin_time}.\n${a.bedrooms_note}\n${a.registration_note}\n${a.concierge}\nServe aiuto? ${a.host_phone}.`},
      {k:'check out',keys:['check out','partenza','lasciare'],t:a=>a.checkout_note},
      {k:'acqua',keys:['acqua','acqua calda','potabile','rubinetto'],t:a=>a.water_note},
      {k:'aria condizionata',keys:['aria condizionata','clima','condizionatore','ac'],t:a=>a.ac_note},
      {k:'bagno',keys:['bagno','asciugacapelli','sapone','asciugamani','wc','avviso'],t:a=>`Bagni: ${a.bathroom_amenities}\nAsciugamani: ${a.towels_note}\n${a.bathroom_notice}`},
      {k:'cucina',keys:['cucina','cucinare','fornello','gas'],t:a=>`${a.kitchen_note}\nUso gas: ${a.gas_steps}`},
      {k:'edificio',keys:['edificio','portone','ascensore','orari','portineria'],t:a=>`Portone: ${a.main_door_hours}\n${a.concierge}`},
      {k:'servizi',keys:['farmacia','ospedale','bancomat','sim','lavanderia','bagagli','supermercato','spesa'],t:a=>`Supermercati: ${a.supermarkets}\nFarmacie: ${a.pharmacies}\nOspedale: ${a.hospital}\nBancomat: ${a.atms}\nLavanderia: ${a.laundry}\nDeposito bagagli: ${a.luggage}\nSIM: ${a.sims}`},
      {k:'trasporti',keys:['trasporti','tram','bus','taxi','aeroporto','treno','metro'],t:a=>`${a.transport}\nAeroporti: ${a.airports}`},
      {k:'mangiare',keys:['mangiare','ristorante','cena','pranzo','cibo'],t:a=>a.eat},
      {k:'bere',keys:['bere','bar','vino','cocktail','aperitivo'],t:a=>a.drink},
      {k:'shopping',keys:['shopping','mercato','negozi','panetterie'],t:a=>a.shop},
      {k:'visitare',keys:['visitare','cosa vedere','museo','attrazioni'],t:a=>a.visit},
      {k:'esperienze',keys:['esperienze','passeggiata','tour','itinerario','tramonto','romantico'],t:a=>`${a.experiences}\nPercorso romantico: ${a.romantic_walk}`},
      {k:'gite di un giorno',keys:['gite','gita','tivoli','ostia','castelli','escursione','bracciano'],t:a=>a.daytrips},
      {k:'emergenza',keys:['emergenza','polizia','ambulanza','fuoco','medico','veterinario'],t:a=>a.emergency}
    ]
  },

  fr: {
    ui:{
      welcome:"Bonjour, je suis Samantha, votre guide virtuel. Touchez un bouton pour une rÃ©ponse rapide.",
      placeholder:"Bonjour, je suis Samantha, votre guide virtuel. Touchez un bouton â€” ou Ã©crivez iciâ€¦",
      apt_label:"Appartement", voice_on:"ðŸ”Š Voix : ActivÃ©e", voice_off:"ðŸ”‡ Voix : DÃ©sactivÃ©e",
      quick:["wifi","check in","check out","eau","climatisation","salle de bain","cuisine","immeuble","manger","boire","shopping","visiter","expÃ©riences","excursions","transports","services","urgence"],
      fallback:"Je nâ€™ai pas trouvÃ© de rÃ©ponse directe. Essayez un bouton (wifi, cuisine, transports, visiterâ€¦)."
    },
    apt:{
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:"PrÃ¨s de la TV se trouve un routeur BLANC. Tournez-le pour lire le SSID et le mot de passe.",
      wifi_ssid:"Voir lâ€™Ã©tiquette du routeur", wifi_password:"Voir lâ€™Ã©tiquette du routeur",
      water_note:"Lâ€™eau du robinet est potable. Lâ€™eau chaude est toujours disponible.",
      ac_note:"Merci dâ€™Ã©teindre la climatisation en quittant lâ€™appartement.",
      bathroom_amenities:"Papier toilette, savon pour les mains, tapis de bain, sÃ¨che-cheveux.",
      towels_note:"Par personne : 1 grande + 1 moyenne. Lits prÃªts Ã  lâ€™arrivÃ©e.",
      bathroom_notice:"IMPORTANT (salle de bain entre les chambres) : nâ€™utilisez QUE le papier toilette fourni. Ne jetez rien dâ€™autre (dÃ©bordement/100 â‚¬).",
      bedrooms_note:"Deux chambres + un canapÃ©-lit double. Les clÃ©s sont sur la table Ã  lâ€™arrivÃ©e.",
      gas_steps:"Robinet de gaz (Ã  gauche du compteur) : BAS = FERMÃ‰ â€¢ HORIZONTAL = OUVERT. Choisir brÃ»leur, appuyer & tourner, maintenir, relÃ¢cher.",
      kitchen_note:"Cuisine entiÃ¨rement Ã©quipÃ©e, prÃªte Ã  lâ€™emploi.",
      main_door_hours:"Porte dâ€™immeuble accessible avec la clÃ© fournie.",
      concierge:"Concierge : Massimo â€” 08:30â€“13:00 et 15:30â€“18:30.",
      registration_note:"Veuillez envoyer vos passeports par WhatsApp Ã  lâ€™hÃ´te (enregistrement obligatoire).",
      host_phone:"+39 335 5245756",
      supermarkets:"Mini-marchÃ© Viale Trastevere (prÃ¨s du 108) â€¢ Produits frais Largo/Piazza San Cosimato (matin).",
      pharmacies:"Pharmacie Piazza Trilussa â€¢ Autres le long de Viale Trastevere.",
      luggage:"Radical Storage â€” Piazza Mastai (â‰ˆ5 min).",
      laundry:"Laverie â€” Viale Trastevere 150.",
      hospital:"Ospedale Nuovo Regina Margherita â€” Via Emilio Morosini 30.",
      atms:"DAB le long de Viale Trastevere (BNL, Unicredit, Intesa).",
      sims:"Vodafone (Viale Trastevere 143) â€¢ TIM (Piazza San Cosimato 70).",
      transport:"Tram 8 â†’ Largo Argentina / Piazza Venezia. Tram 3 Ã  proximitÃ©. Bus H â†’ Termini. Taxi : +39 06 3570 ou FreeNow.",
      airports:"Fiumicino : Tram 8 â†’ gare de Trastevere â†’ FL1 (~45 min). Ciampino : bus â†’ Termini â†’ Tram 8.",
      emergency:"Urgences UE 112 â€¢ Police 113 â€¢ Ambulance 118 â€¢ Pompiers 115 â€¢ MÃ©decin anglophone +39 06 488 2371 â€¢ VÃ©tÃ©rinaire 24h +39 06 660 681",
      eat:"Da Enzo al 29 ; Osteria der Belli ; Tonnarello ; Trattoria Da Teo ; Spirito di Vino ; Pianostrada ; Trapizzino.",
      drink:"Enoteca Ferrara ; Freni e Frizioni ; Lâ€™Angolo Divino ; MimÃ¬ e CocÃ² ; La Prosciutteria.",
      shop:"MarchÃ© Porta Portese (dim) ; boulangeries/traiteurs Viale Trastevere ; boutiques Via della Lungaretta.",
      visit:"Santa Maria in Trastevere ; Santa Cecilia ; MusÃ©e de Rome Ã  Trastevere ; Orto Botanico ; Villa Farnesina ; Piazza Trilussa ; promenade sur le Ponte Sisto vers Campo deâ€™ Fiori.",
      experiences:"Balade du soir : Viale Trastevere â†’ Piazza Trilussa â†’ Santa Maria â†’ ruelles â†’ berges du Tibre â†’ Campo deâ€™ Fiori. ApÃ©ritif chez Freni e Frizioni ; Ã©glises ; coucher de soleil au Janicule.",
      romantic_walk:"DÃ©part : Viale Trastevere 108 â†’ Piazza S. Maria â†’ Terrasse du Janicule â†’ Orto Botanico â†’ Gelateria del Viale â†’ Biscottificio Innocenti â†’ retour.",
      daytrips:"Ostia Antica (~40 min) â€¢ Tivoli (Villa dâ€™Este & dâ€™Hadrien ~1h) â€¢ Castelli Romani.",
      checkout_note:"Avant de partir : Ã©teignez lumiÃ¨res/clim, fermez les fenÃªtres, laissez les clÃ©s sur la table et fermez Ã  clÃ©."
    },
    intents:[
      {k:'wifi',keys:['wifi','wi-fi','internet','mot de passe','routeur'],t:a=>`Wi-Fi : ${a.wifi_note}\nRÃ©seau : ${a.wifi_ssid}. Mot de passe : ${a.wifi_password}.`},
      {k:'check in',keys:['check in','arrivÃ©e','accÃ¨s','self check-in','entrÃ©e','interphone','sonnette'],t:a=>`ArrivÃ©e Ã  partir de ${a.checkin_time}.\n${a.bedrooms_note}\n${a.registration_note}\n${a.concierge}\nBesoin dâ€™aide ? ${a.host_phone}.`},
      {k:'check out',keys:['check out','dÃ©part','quitter'],t:a=>a.checkout_note},
      {k:'eau',keys:['eau','chaude','potable','robinet'],t:a=>a.water_note},
      {k:'climatisation',keys:['climatisation','clim','ac'],t:a=>a.ac_note},
      {k:'salle de bain',keys:['salle de bain','sdb','serviettes','papier','sÃ¨che-cheveux'],t:a=>`Salles de bain : ${a.bathroom_amenities}\nServiettes : ${a.towels_note}\n${a.bathroom_notice}`},
      {k:'cuisine',keys:['cuisine','cuisiner','gaz','plaques'],t:a=>`${a.kitchen_note}\nGaz : ${a.gas_steps}`},
      {k:'immeuble',keys:['immeuble','porte','horaires','concierge','ascenseur'],t:a=>`Porte : ${a.main_door_hours}\n${a.concierge}`},
      {k:'services',keys:['pharmacie','hÃ´pital','dab','sim','laverie','consigne','supermarchÃ©'],t:a=>`SupermarchÃ©s : ${a.supermarkets}\nPharmacies : ${a.pharmacies}\nHÃ´pital : ${a.hospital}\nDAB : ${a.atms}\nLaverie : ${a.laundry}\nConsigne : ${a.luggage}\nCartes SIM : ${a.sims}`},
      {k:'transports',keys:['transports','tram','bus','taxi','aÃ©roport','train','mÃ©tro'],t:a=>`${a.transport}\nAÃ©roports : ${a.airports}`},
      {k:'manger',keys:['manger','restaurant','dÃ®ner','dÃ©jeuner'],t:a=>a.eat},
      {k:'boire',keys:['boire','bar','vin','cocktail','apÃ©ritif'],t:a=>a.drink},
      {k:'shopping',keys:['shopping','marchÃ©','boutiques','boulangeries'],t:a=>a.shop},
      {k:'visiter',keys:['visiter','musÃ©e','attractions','voir'],t:a=>a.visit},
      {k:'expÃ©riences',keys:['expÃ©riences','balade','itinÃ©raire','coucher de soleil','romantique'],t:a=>`${a.experiences}\nParcours romantique : ${a.romantic_walk}`},
      {k:'excursions',keys:['excursions','ostia','tivoli','castelli','journÃ©e'],t:a=>a.daytrips},
      {k:'urgence',keys:['urgence','police','ambulance','pompiers','mÃ©decin','vÃ©tÃ©rinaire'],t:a=>a.emergency}
    ]
  },

  de: {
    ui:{
      welcome:"Hallo, ich bin Samantha, dein virtueller Guide. Tippe auf einen Button fÃ¼r eine schnelle Antwort.",
      placeholder:"Hallo, ich bin Samantha, dein virtueller Guide. Tippe auf einen Button â€” oder schreibe hierâ€¦",
      apt_label:"Apartment", voice_on:"ðŸ”Š Stimme: An", voice_off:"ðŸ”‡ Stimme: Aus",
      quick:["WLAN","check in","check out","Wasser","Klimaanlage","Bad","KÃ¼che","GebÃ¤ude","Essen","Trinken","Shopping","SehenswÃ¼rdigkeiten","Erlebnisse","TagesausflÃ¼ge","Verkehr","Services","Notfall"],
      fallback:"Keine direkte Antwort gefunden. Nutze einen Button (WLAN, KÃ¼che, Verkehr, SehenswÃ¼rdigkeitenâ€¦)."
    },
    apt:{
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:"Neben dem Fernseher steht ein WEISSER Router. Umdrehen, um SSID & Passwort zu sehen.",
      wifi_ssid:"Siehe Router-Etikett", wifi_password:"Siehe Router-Etikett",
      water_note:"Leitungswasser ist trinkbar. Warmwasser ist immer an.",
      ac_note:"Bitte schalten Sie die Klimaanlage aus, wenn Sie die Wohnung verlassen.",
      bathroom_amenities:"Toilettenpapier, Handseife, Badematte, FÃ¶hn.",
      towels_note:"Pro Gast: 1 groÃŸes + 1 mittleres Handtuch. Betten bei Ankunft gemacht.",
      bathroom_notice:"WICHTIG (Bad zwischen den Schlafzimmern): nur bereitgestelltes Papier verwenden. Sonst Verstopfung (100 â‚¬).",
      bedrooms_note:"Zwei Schlafzimmer + Schlafsofa (Doppelbett). SchlÃ¼ssel liegen bei Ankunft auf dem Tisch.",
      gas_steps:"Gashahn (links vom ZÃ¤hler): UNTEN = ZU â€¢ WAAGRECHT = OFFEN. Brenner wÃ¤hlen, drÃ¼cken & drehen, kurz halten, loslassen.",
      kitchen_note:"KÃ¼che vollstÃ¤ndig ausgestattet.",
      main_door_hours:"HaustÃ¼r mit bereitgestelltem SchlÃ¼ssel zugÃ¤nglich.",
      concierge:"Hausmeister: Massimo â€” 08:30â€“13:00 und 15:30â€“18:30.",
      registration_note:"Bitte PÃ¤sse per WhatsApp an den Gastgeber senden (Registrierung).",
      host_phone:"+39 335 5245756",
      supermarkets:"Mini-Market nahe 108 â€¢ Frischemarkt Largo/Piazza San Cosimato (morgens).",
      pharmacies:"Apotheke Piazza Trilussa â€¢ Weitere entlang der Viale Trastevere.",
      luggage:"Radical Storage â€” Piazza Mastai (â‰ˆ5 Min).",
      laundry:"Waschsalon â€” Viale Trastevere 150.",
      hospital:"Ospedale Nuovo Regina Margherita â€” Via Emilio Morosini 30.",
      atms:"Geldautomaten entlang der Viale Trastevere.",
      sims:"Vodafone (Viale Trastevere 143) â€¢ TIM (Piazza San Cosimato 70).",
      transport:"Tram 8 â†’ Largo Argentina/Piazza Venezia. Tram 3 in der NÃ¤he. Bus H â†’ Termini. Taxi: +39 06 3570 oder FreeNow.",
      airports:"Fiumicino: Tram 8 â†’ Bahnhof Trastevere â†’ FL1 (~45 Min). Ciampino: Bus â†’ Termini â†’ Tram 8.",
      emergency:"EU-Notruf 112 â€¢ Polizei 113 â€¢ Rettung 118 â€¢ Feuerwehr 115 â€¢ Arzt (EN) +39 06 488 2371 â€¢ Tierarzt 24h +39 06 660 681",
      eat:"Da Enzo al 29; Osteria der Belli; Tonnarello; Trattoria Da Teo; Spirito di Vino; Pianostrada; Trapizzino.",
      drink:"Enoteca Ferrara; Freni e Frizioni; Lâ€™Angolo Divino; MimÃ¬ e CocÃ²; La Prosciutteria.",
      shop:"Markt Porta Portese (So.); BÃ¤ckereien & Delis auf Viale Trastevere; Boutiquen Via della Lungaretta.",
      visit:"Santa Maria in Trastevere; Santa Cecilia; Museo di Roma in Trastevere; Orto Botanico; Villa Farnesina; Piazza Trilussa; Ã¼ber die Ponte Sisto zum Campo deâ€™ Fiori.",
      experiences:"Abendrunde: Viale Trastevere â†’ Piazza Trilussa â†’ Santa Maria â†’ Gassen â†’ Tiberufer â†’ Campo deâ€™ Fiori. Aperitivo bei Freni e Frizioni; Kirchen; Sonnenuntergang am Gianicolo.",
      romantic_walk:"Start: Viale Trastevere 108 â†’ Piazza S. Maria â†’ Gianicolo-Terrasse â†’ Orto Botanico â†’ Gelateria del Viale â†’ Biscottificio Innocenti â†’ zurÃ¼ck.",
      daytrips:"Ostia Antica (~40 Min) â€¢ Tivoli (Villa dâ€™Este & Hadriansvilla ~1h) â€¢ Castelli Romani.",
      checkout_note:"Vor der Abreise: Licht/AC aus, Fenster schlieÃŸen, SchlÃ¼ssel auf dem Tisch lassen, TÃ¼re abschlieÃŸen."
    },
    intents:[
      {k:'WLAN',keys:['wlan','wifi','wi-fi','internet','passwort','router'],t:a=>`WLAN: ${a.wifi_note}\nNetz: ${a.wifi_ssid}. Passwort: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','ankunft','zugang','selbst check-in','eingang','klingel','sprechanlage'],t:a=>`Check-in ab ${a.checkin_time}.\n${a.bedrooms_note}\n${a.registration_note}\n${a.concierge}\nHilfe? ${a.host_phone}.`},
      {k:'check out',keys:['check out','abreise','verlassen'],t:a=>a.checkout_note},
      {k:'Wasser',keys:['wasser','warmwasser','trinkbar','hahn'],t:a=>a.water_note},
      {k:'Klimaanlage',keys:['klimaanlage','klima','ac'],t:a=>a.ac_note},
      {k:'Bad',keys:['bad','handtÃ¼cher','seife','wc','hinweis','fÃ¶hn'],t:a=>`BÃ¤der: ${a.bathroom_amenities}\nHandtÃ¼cher: ${a.towels_note}\n${a.bathroom_notice}`},
      {k:'KÃ¼che',keys:['kÃ¼che','kochen','herd','gas'],t:a=>`${a.kitchen_note}\nGas: ${a.gas_steps}`},
      {k:'GebÃ¤ude',keys:['gebÃ¤ude','tÃ¼r','zeiten','hausmeister','aufzug'],t:a=>`TÃ¼r: ${a.main_door_hours}\n${a.concierge}`},
      {k:'Services',keys:['apotheke','krankenhaus','geldautomat','sim','wÃ¤scherei','gepÃ¤ck','supermarkt'],t:a=>`SupermÃ¤rkte: ${a.supermarkets}\nApotheken: ${a.pharmacies}\nKrankenhaus: ${a.hospital}\nGeldautomaten: ${a.atms}\nWaschsalon: ${a.laundry}\nGepÃ¤ck: ${a.luggage}\nSIM: ${a.sims}`},
      {k:'Verkehr',keys:['verkehr','tram','bus','taxi','flughafen','zug','metro'],t:a=>`${a.transport}\nFlughÃ¤fen: ${a.airports}`},
      {k:'Essen',keys:['essen','restaurant','abendessen','mittagessen'],t:a=>a.eat},
      {k:'Trinken',keys:['trinken','bar','wein','cocktail','aperitif'],t:a=>a.drink},
      {k:'Shopping',keys:['shopping','markt','geschÃ¤fte','bÃ¤ckereien'],t:a=>a.shop},
      {k:'SehenswÃ¼rdigkeiten',keys:['sehenswÃ¼rdigkeiten','besuchen','museum','attraktionen'],t:a=>a.visit},
      {k:'Erlebnisse',keys:['erlebnisse','spaziergang','tour','route','sonnenuntergang','romantisch'],t:a=>`${a.experiences}\nRomantische Route: ${a.romantic_walk}`},
      {k:'TagesausflÃ¼ge',keys:['tagesausflug','tivoli','ostia','castelli','ausflug'],t:a=>a.daytrips},
      {k:'Notfall',keys:['notfall','polizei','rettung','feuerwehr','arzt','tierarzt'],t:a=>a.emergency}
    ]
  },

  es: {
    ui:{
      welcome:"Hola, soy Samantha, tu guÃ­a virtual. Toca un botÃ³n para una respuesta rÃ¡pida.",
      placeholder:"Hola, soy Samantha, tu guÃ­a virtual. Toca un botÃ³n â€” o escribe aquÃ­â€¦",
      apt_label:"Apartamento", voice_on:"ðŸ”Š Voz: Activada", voice_off:"ðŸ”‡ Voz: Desactivada",
      quick:["wifi","check in","check out","agua","aire acondicionado","baÃ±o","cocina","edificio","comer","beber","compras","visitar","experiencias","excursiones","transporte","servicios","emergencia"],
      fallback:"No encontrÃ© una respuesta directa. Prueba un botÃ³n (wifi, cocina, transporte, visitarâ€¦)."
    },
    apt:{
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:"Cerca de la TV hay un router BLANCO. GÃ­ralo para ver el SSID y la contraseÃ±a.",
      wifi_ssid:"Ver etiqueta del router", wifi_password:"Ver etiqueta del router",
      water_note:"El agua del grifo es potable. El agua caliente estÃ¡ siempre activa.",
      ac_note:"Apaga el aire acondicionado al salir del apartamento.",
      bathroom_amenities:"Papel higiÃ©nico, jabÃ³n de manos, alfombrilla, secador.",
      towels_note:"Por huÃ©sped: 1 toalla grande + 1 mediana. Camas preparadas a la llegada.",
      bathroom_notice:"IMPORTANTE (baÃ±o entre dormitorios): usa SOLO el papel higiÃ©nico proporcionado. No tires nada mÃ¡s (atascos/100 â‚¬).",
      bedrooms_note:"Dos dormitorios + sofÃ¡ cama doble. Las llaves estÃ¡n en la mesa a la llegada.",
      gas_steps:"Llave del gas (izquierda del contador): ABAJO = CERRADO â€¢ HORIZONTAL = ABIERTO. Elegir fogÃ³n, presionar y girar, mantener unos segundos, soltar.",
      kitchen_note:"Cocina completamente equipada y lista para usar.",
      main_door_hours:"Puerta del edificio accesible con la llave proporcionada.",
      concierge:"Conserje: Massimo â€” 08:30â€“13:00 y 15:30â€“18:30.",
      registration_note:"EnvÃ­a los pasaportes por WhatsApp al anfitriÃ³n (registro obligatorio).",
      host_phone:"+39 335 5245756",
      supermarkets:"Mini-market en Viale Trastevere cerca del 108 â€¢ Productos frescos en Largo/Piazza San Cosimato (maÃ±anas).",
      pharmacies:"Farmacia en Piazza Trilussa â€¢ Otras a lo largo de Viale Trastevere.",
      luggage:"Radical Storage â€” Piazza Mastai (â‰ˆ5 min).",
      laundry:"LavanderÃ­a â€” Viale Trastevere 150.",
      hospital:"Ospedale Nuovo Regina Margherita â€” Via Emilio Morosini 30.",
      atms:"Cajeros en Viale Trastevere (BNL, Unicredit, Intesa).",
      sims:"Vodafone (Viale Trastevere 143) â€¢ TIM (Piazza San Cosimato 70).",
      transport:"TranvÃ­a 8 â†’ Largo Argentina / Piazza Venezia. TranvÃ­a 3 cerca. Bus H â†’ Termini. Taxi: +39 06 3570 o app FreeNow.",
      airports:"Fiumicino: TranvÃ­a 8 â†’ EstaciÃ³n Trastevere â†’ FL1 (~45 min). Ciampino: bus a Termini y luego TranvÃ­a 8.",
      emergency:"Emergencia UE 112 â€¢ PolicÃ­a 113 â€¢ Ambulancia 118 â€¢ Bomberos 115 â€¢ MÃ©dico en inglÃ©s +39 06 488 2371 â€¢ Veterinario 24h +39 06 660 681",
      eat:"Da Enzo al 29; Osteria der Belli; Tonnarello; Trattoria Da Teo; Spirito di Vino; Pianostrada; Trapizzino.",
      drink:"Enoteca Ferrara; Freni e Frizioni; Lâ€™Angolo Divino; MimÃ¬ e CocÃ²; La Prosciutteria.",
      shop:"Mercado de Porta Portese (dom.); panaderÃ­as y charcuterÃ­as artesanales; boutiques en Via della Lungaretta.",
      visit:"Santa Maria in Trastevere; Santa Cecilia; Museo de Roma en Trastevere; Orto Botanico; Villa Farnesina; Piazza Trilussa; paseo por el Ponte Sisto hacia Campo deâ€™ Fiori.",
      experiences:"Paseo vespertino: Viale Trastevere â†’ Piazza Trilussa â†’ Santa Maria â†’ callejuelas â†’ ribera del TÃ­ber â†’ Campo deâ€™ Fiori. Aperitivo en Freni e Frizioni; iglesias; atardecer en el Gianicolo.",
      romantic_walk:"Inicio: Viale Trastevere 108 â†’ Plaza S. Maria â†’ Terraza del Gianicolo â†’ Orto Botanico â†’ Gelateria del Viale â†’ Biscottificio Innocenti â†’ regreso.",
      daytrips:"Ostia Antica (~40 min) â€¢ Tivoli (Villa dâ€™Este y Villa Adriana ~1h) â€¢ Castelli Romani.",
      checkout_note:"Antes de salir: apaga luces/AC, cierra ventanas, deja las llaves en la mesa y cierra con llave."
    },
    intents:[
      {k:'wifi',keys:['wifi','wi-fi','internet','contraseÃ±a','router'],t:a=>`Wi-Fi: ${a.wifi_note}\nRed: ${a.wifi_ssid}. ContraseÃ±a: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','llegada','acceso','self check-in','entrada','timbre','portero'],t:a=>`Check-in desde las ${a.checkin_time}.\n${a.bedrooms_note}\n${a.registration_note}\n${a.concierge}\nÂ¿Necesitas ayuda? ${a.host_phone}.`},
      {k:'check out',keys:['check out','salida','marchar'],t:a=>a.checkout_note},
      {k:'agua',keys:['agua','caliente','potable','grifo'],t:a=>a.water_note},
      {k:'aire acondicionado',keys:['aire acondicionado','ac','clima'],t:a=>a.ac_note},
      {k:'baÃ±o',keys:['baÃ±o','toallas','jabÃ³n','wc','aviso','secador'],t:a=>`BaÃ±os: ${a.bathroom_amenities}\nToallas: ${a.towels_note}\n${a.bathroom_notice}`},
      {k:'cocina',keys:['cocina','cocinar','hornilla','gas'],t:a=>`${a.kitchen_note}\nUso del gas: ${a.gas_steps}`},
      {k:'edificio',keys:['edificio','puerta','horarios','conserje','ascensor'],t:a=>`${a.main_door_hours}\n${a.concierge}`},
      {k:'servicios',keys:['farmacia','hospital','cajero','sim','lavanderÃ­a','equipaje','supermercado'],t:a=>`Supermercados: ${a.supermarkets}\nFarmacias: ${a.pharmacies}\nHospital: ${a.hospital}\nCajeros: ${a.atms}\nLavanderÃ­a: ${a.laundry}\nConsigna: ${a.luggage}\nSIM: ${a.sims}`},
      {k:'transporte',keys:['transporte','tranvÃ­a','bus','taxi','aeropuerto','tren','metro'],t:a=>`${a.transport}\nAeropuertos: ${a.airports}`},
      {k:'comer',keys:['comer','restaurante','cena','almuerzo'],t:a=>a.eat},
      {k:'beber',keys:['beber','bar','vino','cÃ³ctel','aperitivo'],t:a=>a.drink},
      {k:'compras',keys:['compras','mercado','tiendas','panaderÃ­as'],t:a=>a.shop},
      {k:'visitar',keys:['visitar','museo','atracciones','ver'],t:a=>a.visit},
      {k:'experiencias',keys:['experiencias','paseo','tour','itinerario','atardecer','romÃ¡ntico'],t:a=>`${a.experiences}\nRuta romÃ¡ntica: ${a.romantic_walk}`},
      {k:'excursiones',keys:['excursiÃ³n','ostia','tivoli','castelli','dÃ­a'],t:a=>a.daytrips},
      {k:'emergencia',keys:['emergencia','policÃ­a','ambulancia','bomberos','mÃ©dico','veterinario'],t:a=>a.emergency}
    ]
  }
}; /* <-- CHIUDE const DATA */

/* ============ RILEVAMENTO LINGUA + UI ============ */
const chatEl = document.getElementById('chat');
const input  = document.getElementById('input');
const sendBtn= document.getElementById('sendBtn');

const url = new URL(location.href);
let lang = (url.searchParams.get('lang') || localStorage.getItem('lang') || (navigator.language||'en').slice(0,2)).toLowerCase();
if(!DATA[lang]) lang='en';
url.searchParams.set('lang',lang); history.replaceState(null,'',url);
localStorage.setItem('lang',lang);

/* ============ TTS MULTILINGUA (voci preferite) ============ */
let voiceOn=false, pick=null;
const VOICE_PREFS = {
  en:['Samantha','Google US English','Google UK English Female','Microsoft Aria Online (Natural)'],
  it:['Alice','Eloisa','Google italiano','Microsoft Elsa Online (Natural)','Microsoft Isabella Online (Natural)'],
  fr:['Amelie','Thomas','Google franÃ§ais','Microsoft Denise Online (Natural)','Microsoft Vivienne Online (Natural)'],
  de:['Anna','Markus','Google Deutsch','Microsoft Katja Online (Natural)','Microsoft Conrad Online (Natural)'],
  es:['Monica','Jorge','Paulina','Google espaÃ±ol','Microsoft Alvaro Online (Natural)']
};
function selectVoice(){
  if(!('speechSynthesis' in window)) return null;
  const all = speechSynthesis.getVoices()||[];
  const prefs = VOICE_PREFS[lang]||[];
  for(const name of prefs){
    const v = all.find(v => (v.name||'').toLowerCase()===name.toLowerCase());
    if(v) return v;
  }
  const byLang = all.find(v => (v.lang||'').toLowerCase().startsWith(lang));
  return byLang || all[0] || null;
}
function refreshVoice(){ pick = selectVoice(); }
if('speechSynthesis' in window){ refreshVoice(); speechSynthesis.onvoiceschanged = refreshVoice; }
function warm(){
  if(!('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const dot = new SpeechSynthesisUtterance('.');
    dot.volume=0.01; if(pick) dot.voice=pick; dot.lang = pick?.lang || lang;
    speechSynthesis.speak(dot);
  }catch{}
}
function speak(t){
  if(!voiceOn || !('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(t);
    if(pick) u.voice=pick; u.lang = pick?.lang || lang;
    speechSynthesis.speak(u);
  }catch{}
}

document.getElementById('voiceBtn').addEventListener('click',e=>{
  voiceOn=!voiceOn; e.currentTarget.setAttribute('aria-pressed',String(voiceOn));
  applyUI(); if(voiceOn) warm();
});
document.querySelector('.lang').addEventListener('click',e=>{
  const btn=e.target.closest('[data-lang]'); if(!btn) return;
  lang = btn.getAttribute('data-lang');
  localStorage.setItem('lang',lang);
  const u=new URL(location.href); u.searchParams.set('lang',lang); history.replaceState(null,'',u);
  refreshVoice(); applyUI(); chatEl.innerHTML=''; welcome();
  if(voiceOn) warm();
});
function applyUI(){
  const L = DATA[lang].ui;
  document.getElementById('aptLabel').textContent = L.apt_label;
  document.getElementById('voiceBtn').textContent = voiceOn ? L.voice_on : L.voice_off;
  input.placeholder = L.placeholder;
  document.querySelectorAll('.lang [data-lang]').forEach(b=> b.setAttribute('aria-current', b.getAttribute('data-lang')===lang ? 'true':'false'));
}

/* ============ CHAT LOGIC + FEEDBACK ============ */
function add(type, txt){
  const d=document.createElement('div');
  d.className='msg '+(type==='me'?'me':'wd');
  d.textContent=txt;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
  return d;
}
function detectIntent(text){
  const L = DATA[lang]; const t = (text||'').toLowerCase();
  let best=null,score=0;
  for(const it of L.intents){
    let s=0; for(const k of it.keys){ if(t.includes(k.toLowerCase())) s++; }
    if(s>score){ score=s; best=it; }
  }
  return best;
}
function getAnswer(text){
  const L = DATA[lang]; const apt=L.apt;
  const m = detectIntent(text);
  if(!m) return { text: L.ui.fallback, topic: 'fallback' };
  try{ return { text: m.t(apt), topic: m.k }; }catch{ return { text: L.ui.fallback, topic: 'fallback' }; }
}
function postFeedback(vote, topic, answerText){
  try{
    fetch(GOOGLE_SCRIPT_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        apartment_id: APARTMENT_ID,
        language: (lang||'en').toUpperCase(),
        topic: topic,
        answer_text: answerText,
        vote: vote
      })
    });
  }catch{}
}
function attachFeedbackUI(container, topic, answerText){
  const box = document.createElement('div');
  box.className = 'fb-box';
  const label = document.createElement('span');
  label.className = 'fb-label';
  label.textContent = 'Was this helpful?';
  const likeBtn = document.createElement('button');
  likeBtn.type='button'; likeBtn.textContent='ðŸ‘ Like';
  const dislikeBtn = document.createElement('button');
  dislikeBtn.type='button'; dislikeBtn.textContent='ðŸ‘Ž Dislike';
  const done = document.createElement('span');
  done.className='fb-done'; done.textContent='Thanks for your feedback!';
  done.style.display='none';
  function finish(v){
    likeBtn.disabled = true; dislikeBtn.disabled = true;
    likeBtn.style.opacity = 0.6; dislikeBtn.style.opacity = 0.6;
    done.style.display = 'inline';
    postFeedback(v, topic, answerText);
  }
  likeBtn.addEventListener('click', ()=>finish('like'));
  dislikeBtn.addEventListener('click', ()=>finish('dislike'));
  box.appendChild(label); box.appendChild(likeBtn); box.appendChild(dislikeBtn); box.appendChild(done);
  container.appendChild(box);
}
function welcome(){
  const L=DATA[lang].ui;
  const intro=document.createElement('div'); intro.className='intro';
  intro.innerHTML = `<b>${L.welcome}</b>`;
  chatEl.appendChild(intro);
  const q=document.createElement('div'); q.className='quick';
  for(const key of L.quick){
    const b=document.createElement('button'); b.textContent=key;
    b.onclick=()=>{ input.value=key; send(); };
    q.appendChild(b);
  }
  chatEl.appendChild(q);
}
function send(){
  const text=(input.value||'').trim(); if(!text) return;
  add('me',text); input.value='';
  const {text:bot, topic} = getAnswer(text);
  const botNode = add('wd',bot); speak(bot);
  attachFeedbackUI(botNode, topic, bot);
}
sendBtn.addEventListener('click',send);
input.addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });
applyUI(); welcome();
</script>
</body>
</html>
