<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Guest Help — Via della Scala 17</title>
<link rel="icon" type="image/jpeg" href="./logo-niceflatinrome.jpg">
<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f6f6}
.wrap{max-width:760px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e0e0e0;padding:10px 14px}
.h-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.h-left{display:flex;align-items:center;gap:10px}
.brand{font-weight:700;color:#a33}
.apt{margin-left:auto;opacity:.75}
img.logo{height:36px;width:auto;display:block}
.controls{display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap}
.lang{display:flex;gap:6px;margin-left:auto}
.lang button{border:1px solid #ddd;background:#fff;padding:6px 8px;border-radius:10px;cursor:pointer;font-size:13px}
.lang button[aria-current="true"]{background:#2b2118;color:#fff;border-color:#2b2118}
#voiceBtn{padding:8px 10px;border:1px solid #ddd;background:#fff;border-radius:10px;cursor:pointer;font-size:14px}
#voiceBtn[aria-pressed="true"]{background:#2b2118;color:#fff;border-color:#2b2118}
main{flex:1;padding:12px}
.msg{max-width:85%;line-height:1.35;border-radius:12px;padding:10px 12px;margin:8px 0;white-space:pre-wrap}
.msg.wd{background:#fff;border:1px solid #e0e0e0}
.msg.me{background:#e8f0fe;border:1px solid #c5d5ff;margin-left:auto}
.quick{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.quick button{border:1px solid #d6c5b8;background:#fff;color:#333;padding:6px 10px;border-radius:12px;cursor:pointer}
.quick button:active{transform:translateY(1px)}
footer{position:sticky;bottom:0;background:#fff;display:flex;gap:8px;padding:10px;border-top:1px solid #e0e0e0}
input{flex:1;padding:12px;border:1px solid #cbd5e1;border-radius:10px;outline:none}
#sendBtn{padding:12px 14px;border:1px solid #2b2118;background:#2b2118;color:#fff;border-radius:10px;cursor:pointer}
.intro{background:#fff;border:1px solid #e0e0e0;padding:12px;border-radius:12px;margin:12px 0}
.intro b{display:block;margin-bottom:6px}
.small{opacity:.7;font-size:12px;margin-top:6px}

/* --- Feedback UI --- */
.fb-box{margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.fb-box .fb-label{font-size:12px;opacity:.7;margin-right:4px}
.fb-box button{border:1px solid #ddd;background:#fff;padding:6px 10px;border-radius:999px;cursor:pointer}
.fb-box button:active{transform:scale(0.98)}
.fb-done{font-size:12px;opacity:.8}

/* === More dropdown (ENG only) — AGGIUNTO === */
.quick .more-btn{
  border:1px solid #d6c5b8;
  background:#fff;
  color:#333;
  padding:6px 10px;
  border-radius:12px;
  cursor:pointer;
  line-height:1;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.quick .more-btn:active{ transform:translateY(1px); }

.more-panel{
  position:absolute;
  z-index:9999;
  min-width:260px;
  max-width:min(92vw,420px);
  background:#fff;
  border:1px solid #e0e0e0;
  border-radius:12px;
  box-shadow:0 6px 22px rgba(0,0,0,.08);
  padding:10px 12px;
  display:none;
}
.more-panel.open{ display:block; }

.more-section{ margin-bottom:12px; }
.more-section:last-child{ margin-bottom:0; }

.more-title{
  font-weight:600;
  font-size:14px;
  margin:4px 0 6px;
  color:#222;
}
.more-links{ display:grid; gap:6px; }
.more-links a{
  text-decoration:none;
  font-size:14px;
  color:#2b2118;
  border:1px dashed #d6c5b8;
  border-radius:10px;
  padding:6px 8px;
  background:#fff;
}
.more-links a:active{ transform:translateY(1px); }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="h-row">
      <div class="h-left">
        <img class="logo" src="./logo-niceflatinrome.jpg" alt="NiceFlatInRome">
        <div class="brand">niceflatinrome.com</div>
      </div>
      <div class="apt"><span id="aptLabel">Apartment</span>: SCALA17</div>
    </div>
    <div class="controls">
      <button id="voiceBtn" aria-pressed="false" title="Toggle voice">🔇 Voice: Off</button>
      <nav class="lang" aria-label="Language">
        <button data-lang="en" aria-current="true">EN</button>
        <button data-lang="it">IT</button>
        <button data-lang="fr">FR</button>
        <button data-lang="de">DE</button>
        <button data-lang="es">ES</button>
      </nav>
    </div>
  </header>

  <main id="chat" aria-live="polite"></main>

  <footer>
    <input id="input" placeholder="Hi, I am Samantha, your virtual guide. Tap a button for a quick answer — or type here…" autocomplete="off">
    <button id="sendBtn">Send</button>
  </footer>
</div>
<script>
/* === CONFIG === */
const APARTMENT_ID = "SCALA17";
/* Usa lo stesso deployment della guida precedente (puoi sostituirlo se fai un nuovo deploy) */
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxt0ToaaC9TOrQMJjcWXpyL1a_FCugoVIgZpB5MFY_IsJTJGHOtloEq1sjKs_F-c7Sd/exec";

/* ============ CONTENUTI LOCALIZZATI (SCALA 17) ============ */
const DATA = {

  en: {
    ui: {
      welcome: "Hi, I am Samantha, your virtual guide. Tap a button to get a quick answer.",
      placeholder: "Hi, I am Samantha, your virtual guide. Tap a button for a quick answer — or type here…",
      apt_label: "Apartment",
      voice_on: "🔊 Voice: On",
      voice_off: "🔇 Voice: Off",
      quick: ["wifi","check in","check out","water","bathroom","gas","eat","drink","shop","visit","experience","day trips","transport","services","emergency"],
      fallback: "I did not find a direct answer. Try a quick button (wifi, gas, transport, visit…)."
    },
    apt: {
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:'Router on the right side of the living room, on a bench. Black cylinder-shaped device; turn it to see SSID & password on the back.',
      wifi_ssid:'See router label', wifi_password:'See router label',
      water_note:'Tap water is safe to drink. Hot water is always on.',
      bathroom_amenities:'Toilet paper, hand soap, hairdryer, bath mat.',
      towels_note:'Per guest: 1 large + 1 medium towel. Bed is prepared on arrival.',
      gas_steps:'Facing the gas meter: steel handle horizontal = OPEN; pointing down = CLOSED. To cook: 1) choose the burner, 2) press & turn the knob, 3) keep it pressed a few seconds until the flame is steady, 4) release.',
      washer_note:'Washing machine manual is in the kitchen drawer. If missing, search your model online and download the PDF manual.',
      intercom_note:'At the entrance there are two intercom columns. Your unit is in the column closest to the door on the left-hand side, first from the bottom. After the first door, the second intercom corresponds to Internal A/1.',
      elevator_note:'—', main_door_hours:'—', concierge:'—',
      pharmacy:'Farmacia Trastevere (Viale Trastevere 116). Other options: Pharmacy near Piazza Trilussa.',
      hospital:'Ospedale Nuovo Regina Margherita (Via Emilio Morosini 30).',
      atms:'Intesa Sanpaolo ATM (Piazza Santa Maria in Trastevere), Unicredit ATM (Viale Trastevere 108).',
      sims:'Vodafone (Viale Trastevere 143), TIM (Piazza San Cosimato 70).',
      laundry:'Self-service laundry: Via della Scala 51.',
      luggage:'Radical Storage points in Trastevere / near Largo Argentina (book online).',
      transport:'Tram 8 from Trastevere → Piazza Venezia. Buses 23 and H connect to the Vatican, Piazza Venezia, and Termini. Walking is best around Trastevere.',
      airports:'Fiumicino: Tram 8 → Trastevere Station → FL1 train (~45 min). Ciampino: Terravision bus or taxi. Private transfer: Welcome Pickups.',
      taxi:'Radio Taxi +39 06 3570 or FreeNow app.',
      emergency:'EU Emergency 112 • Police 113 • Ambulance 118 • Fire 115 • English-speaking doctor +39 06 488 2371 • 24h vet +39 06 660 681',
      eat:'Da Teo — Piazza dei Ponziani 7A; Ristorante La Scala — Piazza della Scala 58–61; Da Carlone — Piazza Sant’Apollonia 11; Osteria Fernanda — Vicolo del Cinque 18; Osteria der Belli — Seafood Sardinian/Roman; Tonnarello — Roman classics; La Tavernaccia — Roast meats, pasta; Nannarella — Homemade pasta',
      drink:'VinAllegro (aperitivo, Piazza G.T. Arquati 114); Freni e Frizioni (cocktails); Bar San Calisto (iconic bar); La Vite (Piazza S. Cosimato 70).',
      shop:'Mercato San Cosimato; Antica Norcineria Iacozzilli; Valzani; Le Levain; Porta Portese (Sun); Twice Vintage; Carlo Cecchini Leather.',
      visit:'Santa Maria in Trastevere; Santa Cecilia; Museo di Roma in Trastevere; Orto Botanico; Villa Farnesina; Ponte Sisto → Campo de’ Fiori → Piazza Navona.',
      experiences:'Scenic loop: Via della Scala → S. Maria in Trastevere → Santa Cecilia → Gianicolo → Orto Botanico. Evening wine at La Vite or San Calisto; pastries at Valzani; romantic stroll over Ponte Sisto.',
      daytrips:'Ostia Antica (~40 min); Tivoli (Villa d’Este & Hadrian’s Villa ~1h); Castelli Romani (villages & wine).',
      romantic_walk:'Start: Via della Scala 17 → Santa Maria in Trastevere → Ponte Sisto (sunset) → Campo de’ Fiori → Piazza Navona → Fior di Luna gelato → Biscottificio Innocenti → back to Via della Scala 17.',
      checkout_note:'Before leaving: turn off lights, close windows, leave keys on the table, gently close the door.',
      host_phone:'+39 335 5245756'
    },
    intents: [
      {k:'wifi',keys:['wifi','wi-fi','internet','password','router'],t:a=>`Wi-Fi: ${a.wifi_note}\nNetwork: ${a.wifi_ssid}. Password: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','arrival','access','intercom','doorbell','code'],t:a=>`Check-in from ${a.checkin_time}. Intercom: ${a.intercom_note}\nNeed help? Call ${a.host_phone}.`},
      {k:'check out',keys:['check out','leave','departure'],t:a=>a.checkout_note},
      {k:'water',keys:['water','hot water','drinkable','tap'],t:a=>a.water_note},
      {k:'bathroom',keys:['bathroom','hairdryer','soap','towels','amenities'],t:a=>`Bathroom: ${a.bathroom_amenities}\nTowels: ${a.towels_note}`},
      {k:'gas',keys:['gas','kitchen','cook','flame','burner'],t:a=>`Gas use: ${a.gas_steps}\nWasher: ${a.washer_note}`},
      {k:'services',keys:['services','pharmacy','hospital','atm','sim','laundry','luggage','numbers'],t:a=>`Pharmacy: ${a.pharmacy}\nHospital: ${a.hospital}\nATMs: ${a.atms}\nSIMs: ${a.sims}\nLaundry: ${a.laundry}\nLuggage: ${a.luggage}`},
      {k:'transport',keys:['transport','tram','bus','taxi','airport','train'],t:a=>`${a.transport}\nAirports: ${a.airports}\nTaxi: ${a.taxi}`},
      {k:'eat',keys:['eat','restaurant','dinner','lunch','food'],t:a=>a.eat},
      {k:'drink',keys:['drink','bar','wine','cocktail','aperitivo'],t:a=>a.drink},
      {k:'shop',keys:['shop','market','shopping','boutique'],t:a=>a.shop},
      {k:'visit',keys:['visit','see','sight','attraction','museum'],t:a=>a.visit},
      {k:'experience',keys:['experience','walk','tour','itinerary','sunset','romantic'],t:a=>`${a.experiences}\nRomantic route: ${a.romantic_walk}`},
      {k:'day trips',keys:['day trip','tivoli','ostia','castelli','excursion'],t:a=>a.daytrips},
      {k:'emergency',keys:['emergency','police','ambulance','fire','doctor','vet'],t:a=>a.emergency}
    ]
  },

  it: {
    ui:{
      welcome:"Ciao, sono Samantha, la tua guida virtuale. Tocca un pulsante per una risposta rapida.",
      placeholder:"Ciao, sono Samantha, la tua guida virtuale. Tocca un pulsante — oppure scrivi qui…",
      apt_label:"Appartamento", voice_on:"🔊 Voce: On", voice_off:"🔇 Voce: Off",
      quick:["wifi","check in","check out","acqua","bagno","gas","mangiare","bere","shopping","visitare","esperienze","gite di un giorno","trasporti","servizi","emergenza"],
      fallback:"Non ho trovato una risposta diretta. Prova un pulsante (wifi, gas, trasporti, visitare…)."
    },
    apt:{
      checkin_time:'15:00', checkout_time:'11:00',
      wifi_note:"Router sul lato destro del soggiorno, su una panca. Dispositivo cilindrico nero: giralo per leggere SSID e password sul retro.",
      wifi_ssid:"Vedi etichetta del router", wifi_password:"Vedi etichetta del router",
      water_note:"L’acqua del rubinetto è potabile. L’acqua calda è sempre attiva.",
      bathroom_amenities:"Carta igienica, sapone mani, asciugacapelli, tappetino.",
      towels_note:"Per ospite: 1 telo grande + 1 medio. Letto pronto all’arrivo.",
      gas_steps:"Di fronte al contatore gas: leva in orizzontale = APERTO; verso il basso = CHIUSO. Per cucinare: 1) scegli il fuoco, 2) premi e gira la manopola, 3) tieni premuto pochi secondi finché la fiamma è stabile, 4) rilascia.",
      washer_note:"Manuale lavatrice nel cassetto della cucina. Se manca, cerca il modello online e scarica il PDF.",
      intercom_note:"All’ingresso ci sono due colonne di citofoni. Il tuo è nella colonna più vicina alla porta sul lato sinistro, il primo dal basso. Dopo il primo portone, il secondo citofono corrisponde a Interno A/1.",
      elevator_note:"—", main_door_hours:"—", concierge:"—",
      pharmacy:"Farmacia Trastevere (Viale Trastevere 116). Altra opzione: farmacia vicino Piazza Trilussa.",
      hospital:"Ospedale Nuovo Regina Margherita (Via Emilio Morosini 30).",
      atms:"Bancomat Intesa (Piazza S. Maria in Trastevere), Unicredit (Viale Trastevere 108).",
      sims:"Vodafone (Viale Trastevere 143), TIM (Piazza San Cosimato 70).",
      laundry:"Lavanderia self-service: Via della Scala 51.",
      luggage:"Punti Radical Storage a Trastevere / vicino Largo Argentina (prenota online).",
      transport:"Tram 8 da Trastevere → Piazza Venezia. Bus 23 e H collegano Vaticano, Piazza Venezia e Termini. A Trastevere si gira bene a piedi.",
      airports:"Fiumicino: Tram 8 → Stazione Trastevere → treno FL1 (~45 min). Ciampino: bus Terravision o taxi. Transfer privato: Welcome Pickups.",
      taxi:"Radio Taxi +39 06 3570 o app FreeNow.",
      emergency:"Emergenze UE 112 • Polizia 113 • Ambulanza 118 • Vigili del Fuoco 115 • Medico in inglese +39 06 488 2371 • Veterinario 24h +39 06 660 681",
      eat:"Da Teo — Piazza dei Ponziani 7A; La Scala — Piazza della Scala 58–61; Da Carlone — Piazza Sant’Apollonia 11; Osteria Fernanda — Vicolo del Cinque 18; Osteria der Belli; Tonnarello; La Tavernaccia; Nannarella.",
      drink:"VinAllegro (aperitivo); Freni e Frizioni (cocktail); Bar San Calisto; La Vite (Piazza S. Cosimato 70).",
      shop:"Mercato S. Cosimato; Antica Norcineria Iacozzilli; Valzani; Le Levain; Porta Portese (dom); Twice Vintage; Carlo Cecchini Leather.",
      visit:"Santa Maria in Trastevere; Santa Cecilia; Museo di Roma in Trastevere; Orto Botanico; Villa Farnesina; Ponte Sisto → Campo de’ Fiori → Piazza Navona.",
      experiences:"Giro scenico: Via della Scala → S. Maria in Trastevere → S. Cecilia → Gianicolo → Orto Botanico. Vino serale a La Vite o San Calisto; dolci da Valzani; passeggiata romantica su Ponte Sisto.",
      daytrips:"Ostia Antica (~40 min); Tivoli (Villa d’Este & Villa Adriana ~1h); Castelli Romani.",
      romantic_walk:"Partenza: Via della Scala 17 → S. Maria in Trastevere → Ponte Sisto (tramonto) → Campo de’ Fiori → Piazza Navona → gelato Fior di Luna → Biscottificio Innocenti → ritorno.",
      checkout_note:"Prima di partire: spegni luci, chiudi le finestre, lascia le chiavi sul tavolo, chiudi delicatamente la porta.",
      host_phone:"+39 335 5245756"
    },
    intents:[
      {k:'wifi',keys:['wifi','wi-fi','internet','password','router'],t:a=>`Wi-Fi: ${a.wifi_note}\nRete: ${a.wifi_ssid}. Password: ${a.wifi_password}.`},
      {k:'check in',keys:['check in','arrivo','accesso','citofono','campanello','codice'],t:a=>`Check-in dalle ${a.checkin_time}. Citofono: ${a.intercom_note}\nAiuto? Chiama ${a.host_phone}.`},
      {k:'check out',keys:['check out','partenza','lasciare'],t:a=>a.checkout_note},
      {k:'acqua',keys:['acqua','acqua calda','potabile','rubinetto'],t:a=>a.water_note},
      {k:'bagno',keys:['bagno','asciugacapelli','sapone','asciugamani','amenities'],t:a=>`Bagno: ${a.bathroom_amenities}\nAsciugamani: ${a.towels_note}`},
      {k:'gas',keys:['gas','cucina','fornello','fiamma','bruciatore'],t:a=>`Uso gas: ${a.gas_steps}\nLavatrice: ${a.washer_note}`},
      {k:'servizi',keys:['servizi','farmacia','ospedale','bancomat','sim','lavanderia','bagagli','numeri'],t:a=>`Farmacia: ${a.pharmacy}\nOspedale: ${a.hospital}\nBancomat: ${a.atms}\nSIM: ${a.sims}\nLavanderia: ${a.laundry}\nDeposito bagagli: ${a.luggage}`},
      {k:'trasporti',keys:['trasporti','tram','bus','taxi','aeroporto','treno'],t:a=>`${a.transport}\nAeroporti: ${a.airports}\nTaxi: ${a.taxi}`},
      {k:'mangiare',keys:['mangiare','ristorante','cena','pranzo','cibo'],t:a=>a.eat},
      {k:'bere',keys:['bere','bar','vino','cocktail','aperitivo'],t:a=>a.drink},
      {k:'shopping',keys:['shopping','mercato','negozi','boutique'],t:a=>a.shop},
      {k:'visitare',keys:['visitare','vedere','attrazioni','museo'],t:a=>a.visit},
      {k:'esperienze',keys:['esperienze','passeggiata','tour','itinerario','tramonto','romantico'],t:a=>`${a.experiences}\nPercorso romantico: ${a.romantic_walk}`},
      {k:'gite di un giorno',keys:['gite','gita','tivoli','ostia','castelli','escursione'],t:a=>a.daytrips},
      {k:'emergenza',keys:['emergenza','polizia','ambulanza','vigili','medico','veterinario'],t:a=>a.emergency}
    ]
  },

  fr: { /* invariato come tuo */ },
  de: { /* invariato come tuo */ },
  es: { /* invariato come tuo */ }

}; /* <-- CHIUDE const DATA */

/* === More menu links (English-only) — AGGIUNTO === */
const MORE_LINKS = [
  {
    title: 'Events (Today)',
    links: [
      { label: 'Wanted in Rome – What’s On', url: 'https://www.wantedinrome.com/whatson' },
      { label: 'Eventbrite – Today in Rome', url: 'https://www.eventbrite.com/d/italy--roma/events--today/' },
      { label: 'Fever – Today in Rome', url: 'https://feverup.com/en/rome/when/today' }
    ]
  },
  {
    title: 'Culture & History',
    links: [
      { label: 'Colosseum Archaeological Park (official)', url: 'https://colosseo.it/en/' },
      { label: 'Vatican Museums (official)', url: 'https://www.museivaticani.va/' },
      { label: 'Capitoline Museums (official)', url: 'https://www.museicapitolini.org/en' }
    ]
  },
  {
    title: 'Cinema & Theatre',
    links: [
      { label: 'Rome Review – Original Language Movies', url: 'https://www.romereview.com/' },
      { label: 'TicketOne – Theatre in Rome', url: 'https://www.ticketone.it/en/city/roma-216/teatro-58/' },
      { label: 'Teatro dell’Opera di Roma (official)', url: 'https://www.operaroma.it/en/' }
    ]
  },
  {
    title: 'Sports & Live Shows',
    links: [
      { label: 'TicketOne – All Events in Rome', url: 'https://www.ticketone.it/en/city/roma-216/' },
      { label: 'AS Roma – Tickets (official)', url: 'https://www.asroma.com/en/tickets' },
      { label: 'S.S. Lazio – Tickets (official)', url: 'https://www.sslazio.it/en/biglietteria/matches' }
    ]
  }
];

/* ============ RILEVAMENTO LINGUA + UI ============ */
const chatEl = document.getElementById('chat');
const input  = document.getElementById('input');
const sendBtn= document.getElementById('sendBtn');

const url = new URL(location.href);
let lang = (url.searchParams.get('lang') || localStorage.getItem('lang') || (navigator.language||'en').slice(0,2)).toLowerCase();
if(!DATA[lang]) lang='en';
url.searchParams.set('lang',lang); history.replaceState(null,'',url);
localStorage.setItem('lang',lang);

/* ============ TTS MULTILINGUA (voci preferite) ============ */
let voiceOn=false, pick=null;
const VOICE_PREFS = {
  en:['Samantha','Google US English','Google UK English Female','Microsoft Aria Online (Natural)'],
  it:['Alice','Eloisa','Google italiano','Microsoft Elsa Online (Natural)','Microsoft Isabella Online (Natural)'],
  fr:['Amelie','Thomas','Google français','Microsoft Denise Online (Natural)','Microsoft Vivienne Online (Natural)'],
  de:['Anna','Markus','Google Deutsch','Microsoft Katja Online (Natural)','Microsoft Conrad Online (Natural)'],
  es:['Monica','Jorge','Paulina','Google español','Microsoft Alvaro Online (Natural)']
};
function selectVoice(){
  if(!('speechSynthesis' in window)) return null;
  const all = speechSynthesis.getVoices()||[];
  const prefs = VOICE_PREFS[lang]||[];
  for(const name of prefs){
    const v = all.find(v => (v.name||'').toLowerCase()===name.toLowerCase());
    if(v) return v;
  }
  const byLang = all.find(v => (v.lang||'').toLowerCase().startsWith(lang));
  return byLang || all[0] || null;
}
function refreshVoice(){ pick = selectVoice(); }
if('speechSynthesis' in window){ refreshVoice(); speechSynthesis.onvoiceschanged = refreshVoice; }
function warm(){
  if(!('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const dot = new SpeechSynthesisUtterance('.');
    dot.volume=0.01; if(pick) dot.voice=pick; dot.lang = pick?.lang || lang;
    speechSynthesis.speak(dot);
  }catch{}
}
function speak(t){
  if(!voiceOn || !('speechSynthesis' in window)) return;
  try{
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(t);
    if(pick) u.voice=pick; u.lang = pick?.lang || lang;
    speechSynthesis.speak(u);
  }catch{}
}

/* === Helpers MENU "More" — AGGIUNTO (solo ENG) === */
function createMorePanel(){
  let panel = document.getElementById('more-panel');
  if(panel) return panel;
  panel = document.createElement('div');
  panel.className = 'more-panel';
  panel.id = 'more-panel';

  MORE_LINKS.forEach(sec=>{
    const box = document.createElement('div');
    box.className='more-section';
    const h = document.createElement('div');
    h.className='more-title';
    h.textContent = sec.title;
    box.appendChild(h);
    const list = document.createElement('div');
    list.className='more-links';
    sec.links.forEach(l=>{
      const a=document.createElement('a');
      a.href=l.url; a.target='_blank'; a.rel='noopener noreferrer';
      a.textContent=l.label;
      list.appendChild(a);
    });
    box.appendChild(list);
    panel.appendChild(box);
  });

  document.body.appendChild(panel);
  return panel;
}
let moreBtnEl=null, morePanelEl=null, moreOpen=false;
function positionPanelUnder(btn, panel){
  const rect=btn.getBoundingClientRect();
  const top = rect.bottom + window.scrollY + 6;
  let left = rect.left + window.scrollX;
  const maxLeft = window.scrollX + (document.documentElement.clientWidth - panel.offsetWidth - 10);
  if(left>maxLeft) left=Math.max(10,maxLeft);
  panel.style.top = `${top}px`;
  panel.style.left = `${left}px`;
}
function openMore(){ if(!moreBtnEl||!morePanelEl) return; morePanelEl.classList.add('open'); positionPanelUnder(moreBtnEl,morePanelEl); moreOpen=true; }
function closeMore(){ if(!morePanelEl) return; morePanelEl.classList.remove('open'); moreOpen=false; if(moreBtnEl) moreBtnEl.setAttribute('aria-expanded','false'); }
function toggleMore(){ if(moreOpen) closeMore(); else openMore(); }
(function installGlobalClosers(){
  document.addEventListener('click',(e)=>{ if(!moreOpen) return;
    const inBtn = moreBtnEl && moreBtnEl.contains(e.target);
    const inPanel = morePanelEl && morePanelEl.contains(e.target);
    if(!inBtn && !inPanel) closeMore();
  });
  window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMore(); });
  window.addEventListener('scroll',()=>{ if(moreOpen) closeMore(); },{passive:true});
  window.addEventListener('resize',()=>{ if(moreOpen) closeMore(); });
})();
function installMoreMenu(container){
  if(container.querySelector('.more-btn')) return;
  const btn = document.createElement('button');
  btn.className='more-btn';
  btn.type='button';
  btn.textContent='More'; // sempre inglese
  btn.setAttribute('aria-expanded','false');
  const panel = createMorePanel();
  btn.addEventListener('click',(e)=>{
    e.stopPropagation();
    moreBtnEl = btn;
    morePanelEl = panel;
    toggleMore();
    btn.setAttribute('aria-expanded', String(moreOpen));
  });
  container.appendChild(btn);
}

/* ============ CHAT LOGIC + FEEDBACK ============ */
document.getElementById('voiceBtn').addEventListener('click',e=>{
  voiceOn=!voiceOn; e.currentTarget.setAttribute('aria-pressed',String(voiceOn));
  applyUI(); if(voiceOn) warm();
});
document.querySelector('.lang').addEventListener('click',e=>{
  const btn=e.target.closest('[data-lang]'); if(!btn) return;
  lang = btn.getAttribute('data-lang');
  localStorage.setItem('lang',lang);
  const u=new URL(location.href); u.searchParams.set('lang',lang); history.replaceState(null,'',u);
  refreshVoice(); applyUI(); chatEl.innerHTML=''; welcome();
  if(voiceOn) warm();
});
function applyUI(){
  const L = DATA[lang].ui;
  document.getElementById('aptLabel').textContent = L.apt_label;
  document.getElementById('voiceBtn').textContent = voiceOn ? L.voice_on : L.voice_off;
  input.placeholder = L.placeholder;
  document.querySelectorAll('.lang [data-lang]').forEach(b=> b.setAttribute('aria-current', b.getAttribute('data-lang')===lang ? 'true':'false'));
}

function add(type, txt){
  const d=document.createElement('div');
  d.className='msg '+(type==='me'?'me':'wd');
  d.textContent=txt;
  chatEl.appendChild(d);
  chatEl.scrollTop=chatEl.scrollHeight;
  return d;
}
function detectIntent(text){
  const L = DATA[lang]; const t = (text||'').toLowerCase();
  let best=null,score=0;
  for(const it of L.intents){
    let s=0; for(const k of it.keys){ if(t.includes(k.toLowerCase())) s++; }
    if(s>score){ score=s; best=it; }
  }
  return best;
}
function getAnswer(text){
  const L = DATA[lang]; const apt=L.apt;
  const m = detectIntent(text);
  if(!m) return { text: L.ui.fallback, topic: 'fallback' };
  try{ return { text: m.t(apt), topic: m.k }; }catch{ return { text: L.ui.fallback, topic: 'fallback' }; }
}

/* --- invio feedback al Google Sheet --- */
function postFeedback(vote, topic, answerText){
  try{
    fetch(GOOGLE_SCRIPT_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        apartment_id: APARTMENT_ID,
        language: (lang||'en').toUpperCase(),
        topic: topic,
        answer_text: answerText,
        vote: vote
      })
    });
  }catch{}
}
function attachFeedbackUI(container, topic, answerText){
  const box = document.createElement('div');
  box.className = 'fb-box';
  const label = document.createElement('span');
  label.className = 'fb-label';
  label.textContent = 'Was this helpful?';
  const likeBtn = document.createElement('button');
  likeBtn.type='button'; likeBtn.textContent='👍 Like';
  const dislikeBtn = document.createElement('button');
  dislikeBtn.type='button'; dislikeBtn.textContent='👎 Dislike';
  const done = document.createElement('span');
  done.className='fb-done'; done.textContent='Thanks for your feedback!';
  done.style.display='none';
  function finish(v){
    likeBtn.disabled = true; dislikeBtn.disabled = true;
    likeBtn.style.opacity = 0.6; dislikeBtn.style.opacity = 0.6;
    done.style.display = 'inline';
    postFeedback(v, topic, answerText);
  }
  likeBtn.addEventListener('click', ()=>finish('like'));
  dislikeBtn.addEventListener('click', ()=>finish('dislike'));
  box.appendChild(label); box.appendChild(likeBtn); box.appendChild(dislikeBtn); box.appendChild(done);
  container.appendChild(box);
}

function welcome(){
  const L=DATA[lang].ui;
  const intro=document.createElement('div'); intro.className='intro';
  intro.innerHTML = `<b>${L.welcome}</b>`;
  chatEl.appendChild(intro);
  const q=document.createElement('div'); q.className='quick';
  for(const key of L.quick){
    const b=document.createElement('button'); b.textContent=key;
    b.onclick=()=>{ input.value=key; send(); };
    q.appendChild(b);
  }
  /* AGGIUNTA: bottone "More" visibile SOLO in inglese */
  if(lang==='en'){ installMoreMenu(q); }

  chatEl.appendChild(q);
}
function send(){
  const text=(input.value||'').trim(); if(!text) return;
  add('me',text); input.value='';
  const {text:bot, topic} = getAnswer(text);
  const botNode = add('wd',bot); speak(bot);
  attachFeedbackUI(botNode, topic, bot);
}
sendBtn.addEventListener('click',send);
input.addEventListener('keydown',e=>{ if(e.key==='Enter') send(); });
applyUI(); welcome();
</script>
</body>
</html>
