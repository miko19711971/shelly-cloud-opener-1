  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title id="title">Check-in Guide — Viale Trastevere 108</title>
<link rel="icon" href="/checkin/trastevere/building-door.jpg">
<style>
  :root { --brand:#2b2118; --ink:#1f2937; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 14px;z-index:5}
  h1{font-size:20px;margin:0}
  .addr{font-size:14px;color:var(--muted)}
  .lang{font-size:14px;margin-top:6px}
  .lang a{color:var(--ink);text-decoration:none;font-weight:700;margin-right:10px}
  .lang a.active{text-decoration:underline}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0}
  .step{display:flex;gap:12px;align-items:flex-start}
  .num{flex:0 0 36px;height:36px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  h2{margin:6px 0 8px 0;font-size:18px}
  p{margin:6px 0;line-height:1.45}
  figure{margin:10px 0}
  img{max-width:100%;height:auto;border-radius:10px;border:1px solid var(--line);display:block}
  figure img{width:90%;margin:0 auto}
  figcaption{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
  .note{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:10px;border-radius:8px;margin-top:8px}
  .cta{display:inline-block;margin-top:10px;padding:10px 12px;border-radius:10px;background:var(--brand);color:#fff;text-decoration:none;cursor:pointer}
  .status{font-size:13px;color:#6b7280;margin-top:6px;min-height:1.2em}
  footer{color:#6b7280;text-align:center;font-size:12px;margin:18px 0}
  .hide{display:none!important}
</style>
</head>
<body>
<header class="wrap">
  <h1 id="h1">Check-in Guide — Viale Trastevere 108</h1>
  <div class="addr" id="addr">Address: Viale Trastevere 108, Rome • Use the buttons below to open the doors.</div>
  <div class="lang" id="langbar">Language: <!-- filled by JS --></div>
</header>
<main class="wrap">

  <!-- Step 1 — Building -->
  <section class="card">
    <div class="step">
      <div class="num">1</div>
      <div>
        <h2 id="s1_t">Open the Building Door</h2>
        <p id="s1_p">Press the button below when you are at the entrance.</p>

        <!-- chiave monouso + scadenza 24h -->
        <a class="cta" href="#"
           onclick="openWith('statusBuilding','/token/viale-trastevere-building?mins=1440&max=1');return false;"
           id="btn_building">➜ Open Building Door</a>
        <div class="status" id="statusBuilding"></div>

        <figure>
          <img id="img_building"
               src="/checkin/trastevere/building-door.jpg"
               alt="Building entrance — Viale Trastevere 108"
               onerror="imgFallback(this,['/checkin/trastevere/entrance.jpg','/checkin/trastevere/building.jpg'])">
          <figcaption id="s1_cap">Façade and entrance — Viale Trastevere 108.</figcaption>
        </figure>

        <p class="note" id="s1_note">
          For security, each key is single-use and expires after 24 hours. If it expires, press the button again to generate a new one-time key.
        </p>
      </div>
    </div>
  </section>

  <!-- Step 2 — Path / Elevator -->
  <section class="card">
    <div class="step">
      <div class="num">2</div>
      <div>
        <h2 id="s2_t">Go to your floor</h2>
        <p id="s2_p">Use the elevator or the stairs to reach your apartment floor.</p>
        <figure>
          <img id="img_corridor"
               src="/checkin/trastevere/elevator-corridor.jpg"
               alt="Corridor / elevator"
               onerror="imgFallback(this,['/checkin/trastevere/corridor.jpg','/checkin/trastevere/elevator.jpg'])">
          <figcaption id="s2_cap">Follow the corridor to the elevator.</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- Step 3 — Apartment -->
  <section class="card">
    <div class="step">
      <div class="num">3</div>
      <div>
        <h2 id="s3_t">Open your Apartment Door</h2>
        <p id="s3_p">Press only once when you are in front of the correct door.</p>

        <!-- chiave monouso + scadenza 24h -->
        <a class="cta" href="#"
           onclick="openWith('statusApartment','/token/viale-trastevere-door?mins=1440&max=1');return false;"
           id="btn_apartment">➜ Open Apartment Door</a>
        <div class="status" id="statusApartment"></div>

        <figure>
          <img id="img_apartment"
               src="/checkin/trastevere/apartment-door.jpg"
               alt="Apartment door — Viale Trastevere 108"
               onerror="imgFallback(this,['/checkin/trastevere/apt-door.jpg','/checkin/trastevere/door.jpg'])">
          <figcaption id="s3_cap">Apartment entrance — Viale Trastevere 108.</figcaption>
        </figure>

        <p class="note" id="s3_note">
          The opening link becomes invalid immediately after one use and, in any case, expires 24 hours after check-in.
        </p>
      </div>
    </div>
  </section>

  <section class="card">
    <h2 id="help_h">Need help?</h2>
    <p id="help_p">Call or WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a></p>
  </section>

  <footer id="footer">niceflatinrome.com • Self check-in guide for Viale Trastevere 108</footer>
</main>

<script>
async function openWith(statusId, path){
  const s=document.getElementById(statusId);
  try{
    s.textContent='Generating one-time key…';
    const r=await fetch(path,{cache:'no-store'});
    if(!r.ok){ s.textContent='Link generation error. Try again.'; return; }
    const j=await r.json();
    if(j && j.url){
      s.textContent='Key OK. Opening…';
      location.href=j.url; // → /k3/... monouso, scadenza 24h
    }else{
      s.textContent=(j && (j.error||j.message)) ? String(j.error||j.message) : 'No URL returned.';
    }
  }catch(e){
    s.textContent='Network error. Try again.';
  }
}

// Fallback immagine: prova una lista di alternative
function imgFallback(img, alternatives){
  if(!alternatives || !alternatives.length) return;
  const next = alternatives.shift();
  img.onerror = ()=> imgFallback(img, alternatives);
  img.src = next;
}
</script>

<script>
const T = {
  en: { title:'Check-in Guide — Viale Trastevere 108', addr:'Address: Viale Trastevere 108, Rome • Use the buttons below to open the doors.',
        s1_t:'Open the Building Door', s1_p:'Press the button below when you are at the entrance.', s1_cap:'Façade and entrance — Viale Trastevere 108.',
        s1_note:'For security, each key is single-use and expires after 24 hours. If it expires, press the button again to generate a new one-time key.',
        s2_t:'Go to your floor', s2_p:'Use the elevator or the stairs to reach your apartment floor.', s2_cap:'Follow the corridor to the elevator.',
        s3_t:'Open your Apartment Door', s3_p:'Press only once when you are in front of the correct door.', s3_cap:'Apartment entrance — Viale Trastevere 108.',
        s3_note:'The opening link becomes invalid immediately after one use and, in any case, expires 24 hours after check-in.',
        help_h:'Need help?', help_p:'Call or WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a>',
        btn_building:'➜ Open Building Door', btn_apartment:'➜ Open Apartment Door',
        footer:'niceflatinrome.com • Self check-in guide for Viale Trastevere 108', langLabel:'Language', langName:'English' },
  it: { title:'Guida Check-in — Viale Trastevere 108', addr:'Indirizzo: Viale Trastevere 108, Roma • Usa i pulsanti sotto per aprire le porte.',
        s1_t:'Apri il Portone del Palazzo', s1_p:'Premi il pulsante quando sei davanti all’ingresso.', s1_cap:'Facciata e ingresso — Viale Trastevere 108.',
        s1_note:'Per sicurezza, ogni chiave è monouso e scade dopo 24 ore. Se scade, premi di nuovo il pulsante per generarne una nuova.',
        s2_t:'Raggiungi il tuo piano', s2_p:'Usa l’ascensore o le scale per raggiungere il piano dell’appartamento.', s2_cap:'Segui il corridoio fino all’ascensore.',
        s3_t:'Apri la Porta dell’Appartamento', s3_p:'Premi una sola volta quando sei davanti alla porta corretta.', s3_cap:'Ingresso appartamento — Viale Trastevere 108.',
        s3_note:'Il link di apertura diventa non valido subito dopo l’uso ed in ogni caso scade 24 ore dopo il check-in.',
        help_h:'Serve aiuto?', help_p:'Chiama o WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a>',
        btn_building:'➜ Apri il portone', btn_apartment:'➜ Apri porta appartamento',
        footer:'niceflatinrome.com • Guida self check-in — Viale Trastevere 108', langLabel:'Lingua', langName:'Italiano' },
  fr: { title:"Guide d’enregistrement — Viale Trastevere 108", addr:"Adresse : Viale Trastevere 108, Rome • Utilisez les boutons ci-dessous pour ouvrir les portes.",
        s1_t:"Ouvrir la porte de l’immeuble", s1_p:"Appuyez sur le bouton lorsque vous êtes à l’entrée.", s1_cap:"Façade et entrée — Viale Trastevere 108.",
        s1_note:"Pour des raisons de sécurité, chaque clé est à usage unique et expire après 24 heures. Si elle expire, appuyez à nouveau pour en générer une nouvelle.",
        s2_t:"Montez à votre étage", s2_p:"Utilisez l’ascenseur ou les escaliers pour rejoindre l’étage de votre appartement.", s2_cap:"Suivez le couloir jusqu’à l’ascenseur.",
        s3_t:"Ouvrir la porte de l’appartement", s3_p:"Appuyez une seule fois lorsque vous êtes devant la bonne porte.", s3_cap:"Entrée de l’appartement — Viale Trastevere 108.",
        s3_note:"Le lien d’ouverture devient invalide immédiatement après usage et, dans tous les cas, expire 24 heures après le check-in.",
        help_h:"Besoin d’aide ?", help_p:'Appeler ou WhatsApp : <a class="cta" href="tel:+393355245756">+39 335 524 5756</a>',
        btn_building:"➜ Ouvrir la porte de l’immeuble", btn_apartment:"➜ Ouvrir la porte de l’appartement",
        footer:"niceflatinrome.com • Guide d’auto check-in — Viale Trastevere 108", langLabel:"Langue", langName:"Français" },
  de: { title:"Check-in-Leitfaden — Viale Trastevere 108", addr:"Adresse: Viale Trastevere 108, Rom • Verwenden Sie die Schaltflächen unten, um die Türen zu öffnen.",
        s1_t:"Haustür öffnen", s1_p:"Drücken Sie die Schaltfläche, wenn Sie am Eingang sind.", s1_cap:"Fassade und Eingang — Viale Trastevere 108.",
        s1_note:"Aus Sicherheitsgründen ist jeder Schlüssel einmalig und läuft nach 24 Stunden ab. Wenn er abläuft, erzeugen Sie über die Schaltfläche einen neuen.",
        s2_t:"Gehen Sie zu Ihrem Stockwerk", s2_p:"Nehmen Sie den Aufzug oder die Treppe, um Ihr Stockwerk zu erreichen.", s2_cap:"Folgen Sie dem Flur bis zum Aufzug.",
        s3_t:"Wohnungstür öffnen", s3_p:"Drücken Sie die Taste nur einmal, wenn Sie vor der richtigen Tür stehen.", s3_cap:"Wohnungseingang — Viale Trastevere 108.",
        s3_note:"Der Öffnungslink wird unmittelbar nach der Nutzung ungültig und läuft zudem 24 Stunden nach dem Check-in ab.",
        help_h:"Brauchen Sie Hilfe?", help_p:'Anrufen oder WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a>',
        btn_building:"➜ Haustür öffnen", btn_apartment:"➜ Wohnungstür öffnen",
        footer:"niceflatinrome.com • Self Check-in Leitfaden — Viale Trastevere 108", langLabel:"Sprache", langName:"Deutsch" },
  es: { title:"Guía de check-in — Viale Trastevere 108", addr:"Dirección: Viale Trastevere 108, Roma • Usa los botones de abajo para abrir las puertas.",
        s1_t:"Abrir la puerta del edificio", s1_p:"Pulsa el botón cuando estés en la entrada.", s1_cap:"Fachada y entrada — Viale Trastevere 108.",
        s1_note:"Por seguridad, cada llave es de un solo uso y caduca a las 24 horas. Si caduca, pulsa de nuevo el botón para generar otra.",
        s2_t:"Ve a tu planta", s2_p:"Usa el ascensor o las escaleras para llegar a tu apartamento.", s2_cap:"Sigue el pasillo hasta el ascensor.",
        s3_t:"Abrir la puerta del apartamento", s3_p:"Pulsa solo una vez cuando estés frente a la puerta correcta.", s3_cap:"Entrada del apartamento — Viale Trastevere 108.",
        s3_note:"El enlace de apertura se invalida inmediatamente tras un uso y, en cualquier caso, caduca 24 horas después del check-in.",
        help_h:"¿Necesitas ayuda?", help_p:'Llama o WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a>',
        btn_building:"➜ Abrir puerta del edificio", btn_apartment:"➜ Abrir puerta del apartamento",
        footer:"niceflatinrome.com • Guía de self check-in — Viale Trastevere 108", langLabel:"Idioma", langName:"Español" }
};

/* Inizializza lingua e UI + barra lingue che mantiene il token */
(function(){
  const params=new URLSearchParams(location.search);
  const L=(params.get('lang')||'en').toLowerCase();
  const t=T[L]||T.en;

  const set = (id, html) => { const el=document.getElementById(id); if(el) el.innerHTML = html; };
  document.getElementById('title').textContent=t.title;
  set('h1', t.title); set('addr', t.addr);
  set('s1_t', t.s1_t); set('s1_p', t.s1_p); set('s1_cap', t.s1_cap); set('s1_note', t.s1_note);
  set('s2_t', t.s2_t); set('s2_p', t.s2_p); set('s2_cap', t.s2_cap);
  set('s3_t', t.s3_t); set('s3_p', t.s3_p); set('s3_cap', t.s3_cap); set('s3_note', t.s3_note);
  set('help_h', t.help_h); set('help_p', t.help_p); set('footer', t.footer);
  document.getElementById('btn_building').textContent = t.btn_building;
  document.getElementById('btn_apartment').textContent = t.btn_apartment;

  // ✅ conserva TUTTI i parametri (incluso t) quando cambi lingua
  const bar = document.getElementById('langbar');
  bar.innerHTML = `${t.langLabel}: ` + Object.keys(T).map(k=>{
    const p = new URLSearchParams(params);
    p.set('lang', k);
    const url = location.pathname + '?' + p.toString();
    const cls = (k===L)?'active':'';
    return `<a class="${cls}" href="${url}">${T[k].langName}</a>`;
  }).join(' · ');
})();
</script>
</body>
</html>
