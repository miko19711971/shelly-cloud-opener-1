<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Check-in Guide — Via del Portico d’Ottavia 1D</title>
<link rel="icon" href="building-door.jpg">
<style>
  :root { --brand:#2b2118; --ink:#1f2937; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb; }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 14px;z-index:5}
  h1{font-size:20px;margin:0}
  .addr{font-size:14px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0}
  .step{display:flex;gap:12px;align-items:flex-start}
  .num{flex:0 0 36px;height:36px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  h2{margin:6px 0 8px 0;font-size:18px}
  p{margin:6px 0;line-height:1.45}
  figure{margin:10px 0}
  img{max-width:100%;height:auto;border-radius:10px;border:1px solid var(--line);display:block}
  figure img{width:90%;margin:0 auto}
  figcaption{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
  .note{background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;padding:10px;border-radius:8px;margin-top:8px}
  .cta{display:inline-block;margin-top:10px;padding:10px 12px;border-radius:10px;background:var(--brand);color:#fff;text-decoration:none;cursor:pointer}
  .status{font-size:13px;color:#6b7280;margin-top:6px}
  footer{color:var(--muted);text-align:center;font-size:12px;margin:18px 0}
</style>
</head>
<body>
<header class="wrap">
  <h1>Check-in Guide — Via del Portico d’Ottavia 1D</h1>
  <div class="addr">Address: Via del Portico d’Ottavia 1D, Rome</div>
</header>

<main class="wrap">
  <!-- STEP 1: OPEN BUILDING DOOR -->
  <section class="card">
    <div class="step">
      <div class="num">1</div>
      <div>
        <h2>Open the Building Door</h2>
        <p>Use the button below to unlock the main door.</p>

        <a class="cta" id="openBuildingBtn" href="#" onclick="openPorticoBuilding();return false;">➜ Open Building Door</a>
        <div class="status" id="statusBuilding"></div>

        <div class="note">Pressing this button will also turn on the indoor corridor lights.</div>

        <figure>
          <img id="img-building" src="building-door.jpg" alt="Building entrance — Via del Portico d’Ottavia 1D">
          <figcaption>Main entrance — Via del Portico d’Ottavia 1D.</figcaption>
        </figure>
        <figure>
          <img id="img-hallway" src="hallway-light.jpg" alt="Hallway lights turned on">
          <figcaption>Corridor lights turn on automatically when you open the building door.</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- STEP 2: ARRIVE AT 3RD FLOOR -->
  <section class="card">
    <div class="step">
      <div class="num">2</div>
      <div>
        <h2>Arrive at the Third Floor</h2>
        <p>Go up to the 3rd floor.</p>
      </div>
    </div>
  </section>

  <!-- STEP 3: OPEN APARTMENT DOOR -->
  <section class="card">
    <div class="step">
      <div class="num">3</div>
      <div>
        <h2>This is Your Apartment Door</h2>
        <p>Please press the button only once when you are certain this is the correct door.</p>

        <a class="cta" id="openApartmentBtn" href="#" onclick="openPorticoApartment();return false;">➜ Open Apartment Door</a>
        <div class="status" id="statusApartment"></div>

        <figure>
          <img id="img-apartment" src="apartment-door.jpg" alt="Apartment door — Via del Portico d’Ottavia 1D">
          <figcaption>Apartment door — 3rd floor.</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Need help?</h2>
    <p>Call or WhatsApp: <a class="cta" href="tel:+393355245756">+39 335 524 5756</a></p>
  </section>

  <footer>niceflatinrome.com • Quick visual guide for arrivals at Via del Portico d’Ottavia 1D</footer>
</main>

<script>
/* ---------- OPEN: try multiple endpoint slugs (fallback chain) ---------- */
async function openWithCandidates(statusEl, candidates){
  statusEl.textContent = 'Generating one-time key…';
  for(const slug of candidates){
    try{
      const r = await fetch(`https://shelly-cloud-opener-1.onrender.com/token/${slug}`, {cache:'no-store'});
      const ct = r.headers.get('content-type') || '';
      let j = null;
      if (ct.includes('application/json')) {
        j = await r.json();
      } else {
        const txt = await r.text();
        statusEl.textContent = `Server said: ${txt.slice(0,180)}…`;
      }
      if (j && j.url){
        statusEl.textContent = `Key OK (${slug}). Opening…`;
        location.href = j.url;
        return;
      }
      if (j && (j.error || j.message)){
        statusEl.textContent = `Server said: ${(j.error||j.message).toString().slice(0,180)}`;
      }
    }catch(e){
      statusEl.textContent = `Network error on ${slug}. Trying next…`;
    }
  }
  statusEl.textContent = 'No working endpoint found. Please try again or contact support.';
}

async function openPorticoBuilding(){
  const s = document.getElementById('statusBuilding');
  const candidates = [
    'ottavia-building',
    'portico-building',
    'portico-ottavia-building'
  ];
  openWithCandidates(s, candidates);
}

async function openPorticoApartment(){
  const s = document.getElementById('statusApartment');
  const candidates = [
    'ottavia-apartment',
    'portico-apartment',
    'portico-ottavia-apartment'
  ];
  openWithCandidates(s, candidates);
}

/* ---------- Image fallback (.JPG/.jpeg) + cache-busting ---------- */
function addImgFallback(imgEl, variants){
  if(!imgEl) return;
  let i = 0;
  imgEl.addEventListener('error', ()=>{
    if (i < variants.length){
      imgEl.src = variants[i] + (variants[i].includes('?') ? '' : `?t=${Date.now()}`);
      i++;
    }
  });
}

window.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('img').forEach(img=>{
    const base = img.getAttribute('src');
    const root = base.replace(/\.(jpg|jpeg|JPG|JPEG).*$/,'');
    addImgFallback(img, [`${root}.JPG`, `${root}.jpeg`]);
    // force reload to avoid stale cache after your re-upload
    img.src = `${base}?t=${Date.now()}`;
  });
});
</script>
</body>
</html>
