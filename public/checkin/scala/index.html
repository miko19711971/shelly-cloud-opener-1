// Check-in — Via della Scala 17, unit A/1 (EN only, simplified)
import express from 'express';
import cors from 'cors';

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static('.')); // serve le immagini dalla root

// ---------- TEXTS ----------
const T = {
  en: {
    title: 'Check-in Guide — Via della Scala 17, unit A/1',
    addressLine: 'Address: Via della Scala 17, Rome • Unit: A/1',
    phone: '+39 335 524 5756',

    s1_t: 'Finding the Building Entrance',
    s1_p: 'Welcome in front of your building door.',
    s1_cap: 'Main entrance — Via della Scala 17.',

    s2_t: 'Enter the Building',
    s2_p: 'Walk straight and on your right-hand side you will find the corridor. Then I will open the door remotely.',
    
    s3_t: 'Pass Through the Corridor',
    s3_p: 'After the click, enter and turn left.',
    s3_cap: 'Follow the arrow, then turn left.',

    s4_t: 'This is your Apartment Door',
    s4_p: 'You’ve reached the green door on the left. This is your apartment entrance.',
    s4_cap: 'Apartment green door — your entrance.',

    help: 'Need help?',
    call: 'Call or WhatsApp',
    footer: 'niceflatinrome.com • Quick visual guide for arrivals at Via della Scala 17, unit A/1'
  }
};

// ---------- ROUTE ----------
app.get('/', (req, res) => {
  const L = T.en;

  const html = `<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${L.title}</title>
<link rel="icon" href="building-door.jpg">
<style>
  :root { --brand:#2b2118; --ink:#1f2937; --muted:#6b7280; --bg:#f7f7f7; --card:#ffffff; --line:#e5e7eb;}
  *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:860px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);padding:12px 14px;z-index:5}
  h1{font-size:20px;margin:0}
  .addr{font-size:14px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin:14px 0}
  .step{display:flex;gap:12px;align-items:flex-start}
  .num{flex:0 0 36px;height:36px;border-radius:50%;background:var(--brand);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
  h2{margin:6px 0 8px 0;font-size:18px}
  p{margin:6px 0;line-height:1.45}
  figure{margin:10px 0}
  img{max-width:100%;height:auto;border-radius:10px;border:1px solid var(--line);display:block}
  figcaption{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
  .cta{display:inline-block;margin-top:6px;padding:7px 10px;border-radius:10px;background:var(--brand);color:#fff;text-decoration:none}
  footer{color:var(--muted);text-align:center;font-size:12px;margin:18px 0}
</style>
<script>
  async function openWith(statusId, path){
    const s=document.getElementById(statusId);
    try{
      s.textContent='Generating one-time key...';
      const r=await fetch(path,{cache:'no-store'});
      const j=await r.json();
      if(j && j.url){ s.textContent='Opening...'; location.href=j.url; }
      else{ s.textContent='Error: ' + (j.error||'no URL'); }
    }catch(e){ s.textContent='Network error. Try again.'; }
  }
</script>
</head>
<body>
<header class="wrap">
  <h1>${L.title}</h1>
  <div class="addr">${L.addressLine}</div>
</header>

<main class="wrap">
  <!-- Step 1 -->
  <section class="card">
    <div class="step">
      <div class="num">1</div>
      <div>
        <h2>${L.s1_t}</h2>
        <p>${L.s1_p}</p>
        <figure>
          <img src="building-door.jpg" alt="Building entrance">
          <figcaption>${L.s1_cap}</figcaption>
        </figure>
        <a class="cta" href="#" onclick="openWith('status1','/token/scala-building')">Open Building Gates</a>
        <div id="status1"></div>
      </div>
    </div>
  </section>

  <!-- Step 2 -->
  <section class="card">
    <div class="step">
      <div class="num">2</div>
      <div>
        <h2>${L.s2_t}</h2>
        <p>${L.s2_p}</p>
      </div>
    </div>
  </section>

  <!-- Step 3 -->
  <section class="card">
    <div class="step">
      <div class="num">3</div>
      <div>
        <h2>${L.s3_t}</h2>
        <p>${L.s3_p}</p>
        <figure>
          <img src="courtyard.jpg" alt="Corridor and arrow">
          <figcaption>${L.s3_cap}</figcaption>
        </figure>
      </div>
    </div>
  </section>

  <!-- Step 4 -->
  <section class="card">
    <div class="step">
      <div class="num">4</div>
      <div>
        <h2>${L.s4_t}</h2>
        <p>${L.s4_p}</p>
        <figure>
          <img src="apartment-green-door.jpg" alt="Apartment green door">
          <figcaption>${L.s4_cap}</figcaption>
        </figure>
        <a class="cta" href="#" onclick="openWith('status2','/token/scala-apartment')">Open Apartment Door</a>
        <div id="status2"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>${L.help}</h2>
    <p>${L.call}: <a class="cta" href="tel:+393355245756">${L.phone}</a></p>
  </section>

  <footer>${L.footer}</footer>
</main>
</body>
</html>`;
  res.setHeader('content-type','text/html; charset=utf-8');
  res.end(html);
});

const port = process.env.PORT || 8787;
app.listen(port, () => console.log('Guide running on http://localhost:' + port));
